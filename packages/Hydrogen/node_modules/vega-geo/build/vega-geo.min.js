!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-util"),require("d3-array"),require("d3-contour"),require("vega-projection"),require("d3-geo")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","d3-array","d3-contour","vega-projection","d3-geo"],t):t(((e=e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.d3,e.d3,e.vega,e.d3)}(this,(function(e,t,n,i,r,a,o){"use strict";var s=["size","smooth"],u=["x","y","weight","size","cellSize","bandwidth"];function f(e){t.Transform.call(this,null,e)}f.Definition={type:"Contour",metadata:{generates:!0},params:[{name:"size",type:"number",array:!0,length:2,required:!0},{name:"values",type:"number",array:!0},{name:"x",type:"field"},{name:"y",type:"field"},{name:"weight",type:"field"},{name:"cellSize",type:"number"},{name:"bandwidth",type:"number"},{name:"count",type:"number"},{name:"smooth",type:"boolean"},{name:"nice",type:"boolean",default:!1},{name:"thresholds",type:"number",array:!0}]},n.inherits(f,t.Transform).transform=function(e,n){if(this.value&&!n.changed()&&!e.modified())return n.StopPropagation;var a,o,f,l,d=n.fork(n.NO_SOURCE|n.NO_FIELDS),p=e.count||10;return e.values?(a=r.contours(),o=s,f=e.values):(a=r.contourDensity(),o=u,f=n.materialize(n.SOURCE).source),a.thresholds(e.thresholds||(e.nice?p:(l=p,function(e){for(var t=i.extent(e),n=t[0],r=t[1]-n,a=[],o=1;o<=l;++o)a.push(n+r*o/(l+1));return a}))),o.forEach((function(t){null!=e[t]&&a[t](e[t])})),this.value&&(d.rem=this.value),f=f&&f.length?a(f).map(t.ingest):[],this.value=d.source=d.add=f,d};var l="Feature",d="FeatureCollection";function p(e){t.Transform.call(this,null,e)}function m(e){t.Transform.call(this,null,e)}function c(e){t.Transform.call(this,null,e)}function h(e){t.Transform.call(this,null,e)}function y(e){t.Transform.call(this,[],e),this.generator=o.geoGraticule()}function g(e){t.Transform.call(this,null,e),this.modified(!0)}function v(e,t,i){n.isFunction(e[t])&&e[t](i)}p.Definition={type:"GeoJSON",metadata:{},params:[{name:"fields",type:"field",array:!0,length:2},{name:"geojson",type:"field"}]},n.inherits(p,t.Transform).transform=function(e,t){var i,r=this._features,a=this._points,o=e.fields,s=o&&o[0],u=o&&o[1],f=e.geojson||!o&&n.identity,p=t.ADD;i=e.modified()||t.changed(t.REM)||t.modified(n.accessorFields(f))||s&&t.modified(n.accessorFields(s))||u&&t.modified(n.accessorFields(u)),this.value&&!i||(p=t.SOURCE,this._features=r=[],this._points=a=[]),f&&t.visit(p,(function(e){r.push(f(e))})),s&&u&&(t.visit(p,(function(e){var t=s(e),n=u(e);null!=t&&null!=n&&(t=+t)===t&&(n=+n)===n&&a.push([t,n])})),r=r.concat({type:l,geometry:{type:"MultiPoint",coordinates:a}})),this.value={type:d,features:r}},m.Definition={type:"GeoPath",metadata:{modifies:!0},params:[{name:"projection",type:"projection"},{name:"field",type:"field"},{name:"pointRadius",type:"number",expr:!0},{name:"as",type:"string",default:"path"}]},n.inherits(m,t.Transform).transform=function(e,t){var i=t.fork(t.ALL),r=this.value,o=e.field||n.identity,s=e.as||"path",u=i.SOURCE;!r||e.modified()?(this.value=r=a.getProjectionPath(e.projection),i.materialize().reflow()):u=o===n.identity||t.modified(o.fields)?i.ADD_MOD:i.ADD;var f=function(e,t){var n=e.pointRadius();e.context(null),null!=t&&e.pointRadius(t);return n}(r,e.pointRadius);return i.visit(u,(function(e){e[s]=r(o(e))})),r.pointRadius(f),i.modifies(s)},c.Definition={type:"GeoPoint",metadata:{modifies:!0},params:[{name:"projection",type:"projection",required:!0},{name:"fields",type:"field",array:!0,required:!0,length:2},{name:"as",type:"string",array:!0,length:2,default:["x","y"]}]},n.inherits(c,t.Transform).transform=function(e,t){var n,i=e.projection,r=e.fields[0],a=e.fields[1],o=e.as||["x","y"],s=o[0],u=o[1];function f(e){var t=i([r(e),a(e)]);t?(e[s]=t[0],e[u]=t[1]):(e[s]=void 0,e[u]=void 0)}return e.modified()?t=t.materialize().reflow(!0).visit(t.SOURCE,f):(n=t.modified(r.fields)||t.modified(a.fields),t.visit(n?t.ADD_MOD:t.ADD,f)),t.modifies(o)},h.Definition={type:"GeoShape",metadata:{modifies:!0,nomod:!0},params:[{name:"projection",type:"projection"},{name:"field",type:"field",default:"datum"},{name:"pointRadius",type:"number",expr:!0},{name:"as",type:"string",default:"shape"}]},n.inherits(h,t.Transform).transform=function(e,t){var i=t.fork(t.ALL),r=this.value,o=e.as||"shape",s=i.ADD;return r&&!e.modified()||(this.value=r=function(e,t,n){var i=null==n?function(n){return e(t(n))}:function(i){var r=e.pointRadius(),a=e.pointRadius(n)(t(i));return e.pointRadius(r),a};return i.context=function(t){return e.context(t),i},i}(a.getProjectionPath(e.projection),e.field||n.field("datum"),e.pointRadius),i.materialize().reflow(),s=i.SOURCE),i.visit(s,(function(e){e[o]=r})),i.modifies(o)},y.Definition={type:"Graticule",metadata:{changes:!0,generates:!0},params:[{name:"extent",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"extentMajor",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"extentMinor",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"step",type:"number",array:!0,length:2},{name:"stepMajor",type:"number",array:!0,length:2,default:[90,360]},{name:"stepMinor",type:"number",array:!0,length:2,default:[10,10]},{name:"precision",type:"number",default:2.5}]},n.inherits(y,t.Transform).transform=function(e,i){var r,a=this.value,o=this.generator;if(!a.length||e.modified())for(var s in e)n.isFunction(o[s])&&o[s](e[s]);return r=o(),a.length?i.mod.push(t.replace(a[0],r)):i.add.push(t.ingest(r)),a[0]=r,i},n.inherits(g,t.Transform).transform=function(e,t){var i=this.value;return!i||e.modified("type")?(this.value=i=function(e){var t=a.projection((e||"mercator").toLowerCase());t||n.error("Unrecognized projection type: "+e);return t()}(e.type),a.projectionProperties.forEach((function(t){null!=e[t]&&v(i,t,e[t])}))):a.projectionProperties.forEach((function(t){e.modified(t)&&v(i,t,e[t])})),null!=e.pointRadius&&i.path.pointRadius(e.pointRadius),e.fit&&function(e,t){var i=function(e){return 1===(e=n.array(e)).length?e[0]:{type:d,features:e.reduce((e,t)=>e.concat(function(e){return e.type===d?e.features:n.array(e).filter(e=>null!=e).map(e=>e.type===l?e:{type:l,geometry:e})}(t)),[])}}(t.fit);t.extent?e.fitExtent(t.extent,i):t.size&&e.fitSize(t.size,i)}(i,e),t.fork(t.NO_SOURCE|t.NO_FIELDS)},e.contour=f,e.geojson=p,e.geopath=m,e.geopoint=c,e.geoshape=h,e.graticule=y,e.projection=g,Object.defineProperty(e,"__esModule",{value:!0})}));