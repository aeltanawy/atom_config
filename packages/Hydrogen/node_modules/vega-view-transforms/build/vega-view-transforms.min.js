!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util"],t):t(((e=e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.vega)}(this,(function(e,t,n,r){"use strict";const o="top",a="left",i="right",s="bottom",u="top-left",c="top-right",d="bottom-left",l="bottom-right",f="start",h="middle",m="end",y="x",b="y",x="group",g="axis",p="title",w="frame",v="scope",k="legend",M="row-header",E="row-footer",T="row-title",_="column-header",A="column-footer",z="column-title",B="padding",D="symbol",O="fit",j="fit-x",q="fit-y",S="pad",L="none",I="all",P="each",C="flush",F="column",G="row";function H(e){t.Transform.call(this,null,e)}function R(e,t,n){return t(e.bounds.clear(),e,n)}r.inherits(H,t.Transform).transform=function(e,t){var r,o=t.dataflow,a=e.mark,i=a.marktype,s=n.Marks[i],u=s.bound,c=a.bounds;if(s.nested)a.items.length&&o.dirty(a.items[0]),c=R(a,u),a.items.forEach((function(e){e.bounds.clear().union(c)}));else if(i===x||e.modified())switch(t.visit(t.MOD,(function(e){o.dirty(e)})),c.clear(),a.items.forEach((function(e){c.union(R(e,u))})),a.role){case g:case k:case p:t.reflow()}else r=t.changed(t.REM),t.visit(t.ADD,(function(e){c.union(R(e,u))})),t.visit(t.MOD,(function(e){r=r||c.alignsWith(e.bounds),o.dirty(e),c.union(R(e,u))})),r&&(c.clear(),a.items.forEach((function(e){c.union(e.bounds)})));return n.boundClip(a),t.modifies("bounds")};var U=":vega_identifier:";function V(e){t.Transform.call(this,0,e)}function W(e){t.Transform.call(this,null,e)}function J(e){t.Transform.call(this,null,e)}V.Definition={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]},r.inherits(V,t.Transform).transform=function(e,t){var n=function(e){var t=e._signals[U];t||(e._signals[U]=t=e.add(0));return t}(t.dataflow),r=n.value,o=e.as;return t.visit(t.ADD,(function(e){e[o]||(e[o]=++r)})),n.set(this.value=r),t},r.inherits(W,t.Transform).transform=function(e,t){var r=this.value;r||((r=t.dataflow.scenegraph().mark(e.markdef,function(e){var t=e.groups,n=e.parent;return t&&1===t.size?t.get(Object.keys(t.object)[0]):t&&n?t.lookup(n):null}(e),e.index)).group.context=e.context,e.context.group||(e.context.group=r.group),r.source=this.source,r.clip=e.clip,r.interactive=e.interactive,this.value=r);var o=r.marktype===x?n.GroupItem:n.Item;return t.visit(t.ADD,(function(e){o.call(e,r)})),(e.modified("clip")||e.modified("interactive"))&&(r.clip=e.clip,r.interactive=!!e.interactive,r.zdirty=!0,t.reflow()),r.items=t.source,t};var K=r.inherits(J,t.Transform),N={parity:function(e){return e.filter((e,t)=>t%2?e.opacity=0:1)},greedy:function(e,t){var n;return e.filter((e,r)=>r&&Q(n.bounds,e.bounds,t)?e.opacity=0:(n=e,1))}};function Q(e,t,n){return n>Math.max(t.x1-e.x2,e.x1-t.x2,t.y1-e.y2,e.y1-t.y2)}function X(e,t){for(var n,r=1,o=e.length,a=e[0].bounds;r<o;a=n,++r)if(Q(a,n=e[r].bounds,t))return!0}function Y(e){var t=e.bounds;return t.width()>1&&t.height()>1}function Z(e){return e.forEach(e=>e.opacity=1),e}function $(e,t){return e.reflow(t.modified()).modifies("opacity")}function ee(e){t.Transform.call(this,null,e)}K.transform=function(e,t){var a,i,u,c=N[e.method]||N.parity,d=t.materialize(t.SOURCE).source,l=e.separation||0;if(d&&d.length){if(!e.method)return e.modified("method")&&(Z(d),t=$(t,e)),t;if(e.sort&&(d=d.slice().sort(e.sort)),a=Z(d=d.filter(Y)),t=$(t,e),a.length>=3&&X(a,l)){do{a=c(a,l)}while(a.length>=3&&X(a,l));a.length<3&&!r.peek(d).opacity&&(a.length>1&&(r.peek(a).opacity=0),r.peek(d).opacity=1)}var f,h,m,y,b;return e.boundScale&&e.boundTolerance>=0&&(f=e.boundScale,h=e.boundOrient,m=+e.boundTolerance,y=f.range(),b=new n.Bounds,h===o||h===s?b.set(y[0],-1/0,y[1],1/0):b.set(-1/0,y[0],1/0,y[1]),b.expand(m||1),i=e=>b.encloses(e.bounds),d.forEach(e=>{i(e)||(e.opacity=0)})),u=a[0].mark.bounds.clear(),d.forEach(e=>{e.opacity&&u.union(e.bounds)}),t}},r.inherits(ee,t.Transform).transform=function(e,t){var n=t.dataflow;if(t.visit(t.ALL,(function(e){n.dirty(e)})),t.fields&&t.fields.zindex){var r=t.source&&t.source[0];r&&(r.mark.zdirty=!0)}};const te=new n.Bounds;function ne(e,t,n){return e[t]===n?0:(e[t]=n,1)}const re=.5;function oe(e){var t=e.items[0].datum.orient;return t===a||t===i}function ae(e,t,r,u){var c,d,l=t.items[0],f=l.datum,h=f.orient,m=function(e){var t=+e.grid;return[e.ticks?t++:-1,e.labels?t++:-1,t+ +e.domain]}(f),y=l.range,b=l.offset,x=l.position,g=l.minExtent,p=l.maxExtent,w=f.title&&l.items[m[2]].items[0],v=l.titlePadding,k=l.bounds,M=w&&n.multiLineOffset(w),E=0,T=0;switch(te.clear().union(k),k.clear(),(c=m[0])>-1&&k.union(l.items[c].bounds),(c=m[1])>-1&&k.union(l.items[c].bounds),h){case o:E=x||0,T=-b,d=Math.max(g,Math.min(p,-k.y1)),w&&(d=ie(e,w,d,v,M,0,-1,k)),k.add(0,-d).add(y,0);break;case a:E=-b,T=x||0,d=Math.max(g,Math.min(p,-k.x1)),w&&(d=ie(e,w,d,v,M,1,-1,k)),k.add(-d,0).add(0,y);break;case i:E=r+b,T=x||0,d=Math.max(g,Math.min(p,k.x2)),w&&(d=ie(e,w,d,v,M,1,1,k)),k.add(0,0).add(d,y);break;case s:E=x||0,T=u+b,d=Math.max(g,Math.min(p,k.y2)),w&&(d=ie(e,w,d,v,0,0,1,k)),k.add(0,0).add(y,d);break;default:E=l.x,T=l.y}return n.boundStroke(k.translate(E,T),l),ne(l,"x",E+re)|ne(l,"y",T+re)&&(l.bounds=te,e.dirty(l),l.bounds=k,e.dirty(l)),l.mark.bounds.clear().union(k)}function ie(e,t,n,r,o,a,i,s){var u=t.bounds,c=0,d=0;return t.auto?(e.dirty(t),n+=r,a?c=(t.x||0)-(t.x=i*(n+o)):d=(t.y||0)-(t.y=i*(n+o)),t.mark.bounds.clear().union(u.translate(-c,-d)),e.dirty(t),a?(s.add(0,u.y1).add(0,u.y2),n+=u.width()):(s.add(u.x1,0).add(u.x2,0),n+=u.height())):s.union(u),n}function se(e){return(new n.Bounds).set(0,0,e.width||0,e.height||0)}function ue(e){var t=e.bounds.clone();return t.empty()?t.set(0,0,0,0):t.translate(-(e.x||0),-(e.y||0))}function ce(e,t,n){var o=r.isObject(e)?e[t]:e;return null!=o?o:void 0!==n?n:0}function de(e){return e<0?Math.ceil(-e):0}function le(e,t,n){var r,o,a,i,s,u,c,d,l,f,x,g=!n.nodirty,p=n.bounds===C?se:ue,w=te.set(0,0,0,0),v=ce(n.align,F),k=ce(n.align,G),M=ce(n.padding,F),E=ce(n.padding,G),T=n.columns||t.length,_=T<0?1:Math.ceil(t.length/T),A=t.length,z=Array(A),B=Array(T),D=0,O=Array(A),j=Array(_),q=0,S=Array(A),L=Array(A),H=Array(A);for(o=0;o<T;++o)B[o]=0;for(o=0;o<_;++o)j[o]=0;for(o=0;o<A;++o)u=t[o],s=H[o]=p(u),u.x=u.x||0,S[o]=0,u.y=u.y||0,L[o]=0,a=o%T,i=~~(o/T),D=Math.max(D,c=Math.ceil(s.x2)),q=Math.max(q,d=Math.ceil(s.y2)),B[a]=Math.max(B[a],c),j[i]=Math.max(j[i],d),z[o]=M+de(s.x1),O[o]=E+de(s.y1),g&&e.dirty(t[o]);for(o=0;o<A;++o)o%T==0&&(z[o]=0),o<T&&(O[o]=0);if(v===P)for(a=1;a<T;++a){for(x=0,o=a;o<A;o+=T)x<z[o]&&(x=z[o]);for(o=a;o<A;o+=T)z[o]=x+B[a-1]}else if(v===I){for(x=0,o=0;o<A;++o)o%T&&x<z[o]&&(x=z[o]);for(o=0;o<A;++o)o%T&&(z[o]=x+D)}else for(v=!1,a=1;a<T;++a)for(o=a;o<A;o+=T)z[o]+=B[a-1];if(k===P)for(i=1;i<_;++i){for(x=0,r=(o=i*T)+T;o<r;++o)x<O[o]&&(x=O[o]);for(o=i*T;o<r;++o)O[o]=x+j[i-1]}else if(k===I){for(x=0,o=T;o<A;++o)x<O[o]&&(x=O[o]);for(o=T;o<A;++o)O[o]=x+q}else for(k=!1,i=1;i<_;++i)for(r=(o=i*T)+T;o<r;++o)O[o]+=j[i-1];for(l=0,o=0;o<A;++o)l=z[o]+(o%T?l:0),S[o]+=l-t[o].x;for(a=0;a<T;++a)for(f=0,o=a;o<A;o+=T)f+=O[o],L[o]+=f-t[o].y;if(v&&ce(n.center,F)&&_>1)for(o=0;o<A;++o)(l=(s=v===I?D:B[o%T])-H[o].x2-t[o].x-S[o])>0&&(S[o]+=l/2);if(k&&ce(n.center,G)&&1!==T)for(o=0;o<A;++o)(f=(s=k===I?q:j[~~(o/T)])-H[o].y2-t[o].y-L[o])>0&&(L[o]+=f/2);for(o=0;o<A;++o)w.union(H[o].translate(S[o],L[o]));switch(l=ce(n.anchor,y),f=ce(n.anchor,b),ce(n.anchor,F)){case m:l-=w.width();break;case h:l-=w.width()/2}switch(ce(n.anchor,G)){case m:f-=w.height();break;case h:f-=w.height()/2}for(l=Math.round(l),f=Math.round(f),w.clear(),o=0;o<A;++o)t[o].mark.bounds.clear();for(o=0;o<A;++o)(u=t[o]).x+=S[o]+=l,u.y+=L[o]+=f,w.union(u.mark.bounds.union(u.bounds.translate(S[o],L[o]))),g&&e.dirty(u);return w}function fe(e,t,n){var r,o,a,i,s,u,c,d=function(e){for(var t,n,r=e.items,o=r.length,a=0,i={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};a<o;++a)if(n=(t=r[a]).items,t.marktype===x)switch(t.role){case g:case k:case p:break;case M:i.rowheaders.push(...n);break;case E:i.rowfooters.push(...n);break;case _:i.colheaders.push(...n);break;case A:i.colfooters.push(...n);break;case T:i.rowtitle=n[0];break;case z:i.coltitle=n[0];break;default:i.marks.push(...n)}return i}(t),l=d.marks,f=n.bounds===C?he:me,h=n.offset,y=n.columns||l.length,b=y<0?1:Math.ceil(l.length/y),w=b*y;const v=le(e,l,n);d.rowheaders&&(u=ce(n.headerBand,G,null),r=xe(e,d.rowheaders,l,y,b,-ce(h,"rowHeader"),ye,0,f,"x1",0,y,1,u)),d.colheaders&&(u=ce(n.headerBand,F,null),o=xe(e,d.colheaders,l,y,y,-ce(h,"columnHeader"),ye,1,f,"y1",0,1,y,u)),d.rowfooters&&(u=ce(n.footerBand,G,null),a=xe(e,d.rowfooters,l,y,b,ce(h,"rowFooter"),be,0,f,"x2",y-1,y,1,u)),d.colfooters&&(u=ce(n.footerBand,F,null),i=xe(e,d.colfooters,l,y,y,ce(h,"columnFooter"),be,1,f,"y2",w-y,1,y,u)),d.rowtitle&&(s=ce(n.titleAnchor,G),c=ce(h,"rowTitle"),c=s===m?a+c:r-c,u=ce(n.titleBand,G,.5),ge(e,d.rowtitle,c,0,v,u)),d.coltitle&&(s=ce(n.titleAnchor,F),c=ce(h,"columnTitle"),c=s===m?i+c:o-c,u=ce(n.titleBand,F,.5),ge(e,d.coltitle,c,1,v,u))}function he(e,t){return"x1"===t?e.x||0:"y1"===t?e.y||0:"x2"===t?(e.x||0)+(e.width||0):"y2"===t?(e.y||0)+(e.height||0):void 0}function me(e,t){return e.bounds[t]}function ye(e,t){return Math.floor(Math.min(e,t))}function be(e,t){return Math.ceil(Math.max(e,t))}function xe(e,t,n,r,o,a,i,s,u,c,d,l,f,h){var m,y,b,x,g,p,w,v,k,M=n.length,E=0,T=0;if(!M)return E;for(m=d;m<M;m+=l)n[m]&&(E=i(E,u(n[m],c)));if(!t.length)return E;for(t.length>o&&(e.warn("Grid headers exceed limit: "+o),t=t.slice(0,o)),E+=a,y=0,x=t.length;y<x;++y)e.dirty(t[y]),t[y].mark.bounds.clear();for(m=d,y=0,x=t.length;y<x;++y,m+=l){for(g=(p=t[y]).mark.bounds,b=m;b>=0&&null==(w=n[b]);b-=f);s?(v=null==h?w.x:Math.round(w.bounds.x1+h*w.bounds.width()),k=E):(v=E,k=null==h?w.y:Math.round(w.bounds.y1+h*w.bounds.height())),g.union(p.bounds.translate(v-(p.x||0),k-(p.y||0))),p.x=v,p.y=k,e.dirty(p),T=i(T,g[c])}return T}function ge(e,t,n,r,o,a){if(t){e.dirty(t);var i=n,s=n;r?i=Math.round(o.x1+a*o.width()):s=Math.round(o.y1+a*o.height()),t.bounds.translate(i-(t.x||0),s-(t.y||0)),t.mark.bounds.clear().union(t.bounds),t.x=i,t.y=s,e.dirty(t)}}function pe(e,t,n,r,y,b,x){const g=function(e,t){const n=e[t]||{};return(t,r)=>null!=n[t]?n[t]:null!=e[t]?e[t]:r}(n,t),p=function(e,t){var n=-1/0;return e.forEach(e=>{null!=e.offset&&(n=Math.max(n,e.offset))}),n>-1/0?n:t}(e,g("offset",0)),w=g("anchor",f),v=w===m?1:w===h?.5:0,k={align:P,bounds:g("bounds",C),columns:"vertical"===g("direction")?1:e.length,padding:g("margin",8),center:g("center"),nodirty:!0};switch(t){case a:k.anchor={x:Math.floor(r.x1)-p,column:m,y:v*(x||r.height()+2*r.y1),row:w};break;case i:k.anchor={x:Math.ceil(r.x2)+p,y:v*(x||r.height()+2*r.y1),row:w};break;case o:k.anchor={y:Math.floor(y.y1)-p,row:m,x:v*(b||y.width()+2*y.x1),column:w};break;case s:k.anchor={y:Math.ceil(y.y2)+p,x:v*(b||y.width()+2*y.x1),column:w};break;case u:k.anchor={x:p,y:p};break;case c:k.anchor={x:b-p,y:p,column:m};break;case d:k.anchor={x:p,y:x-p,row:m};break;case l:k.anchor={x:b-p,y:x-p,column:m,row:m}}return k}function we(e,t){var r,o,u,c,d=t.items[0],l=d.datum,f=d.orient,h=d.bounds,y=d.x,b=d.y;return d._bounds?d._bounds.clear().union(h):d._bounds=h.clone(),h.clear(),function(e,t,n){var r=t.padding,o=r-n.x,u=r-n.y;if(t.datum.title){var c=t.items[1].items[0],d=c.anchor,l=t.titlePadding||0,f=r-c.x,h=r-c.y;switch(c.orient){case a:o+=Math.ceil(c.bounds.width())+l;break;case i:case s:break;default:u+=c.bounds.height()+l}switch((o||u)&&ke(e,n,o,u),c.orient){case a:h+=ve(t,n,c,d,1,1);break;case i:f+=ve(t,n,c,m,0,0)+l,h+=ve(t,n,c,d,1,1);break;case s:f+=ve(t,n,c,d,0,0),h+=ve(t,n,c,m,-1,0,1)+l;break;default:f+=ve(t,n,c,d,0,0)}(f||h)&&ke(e,c,f,h),(f=Math.round(c.bounds.x1-r))<0&&(ke(e,n,-f,0),ke(e,c,-f,0))}else(o||u)&&ke(e,n,o,u)}(e,d,d.items[0].items[0]),h=function(e,t){return e.items.forEach(e=>t.union(e.bounds)),t.x1=e.padding,t.y1=e.padding,t}(d,h),r=2*d.padding,o=2*d.padding,h.empty()||(r=Math.ceil(h.width()+r),o=Math.ceil(h.height()+o)),l.type===D&&(u=d.items[0].items[0].items[0].items,c=u.reduce((function(e,t){return e[t.column]=Math.max(t.bounds.x2-t.x,e[t.column]||0),e}),{}),u.forEach((function(e){e.width=c[e.column],e.height=e.bounds.y2-e.y}))),f!==L&&(d.x=y=0,d.y=b=0),d.width=r,d.height=o,n.boundStroke(h.set(y,b,y+r,b+o),d),d.mark.bounds.clear().union(h),d}function ve(e,t,r,o,a,i,s){const u="symbol"!==e.datum.type,c=r.datum.vgrad,d=(!u||!i&&c||s?t:t.items[0]).bounds[a?"y2":"x2"]-e.padding,l=c&&i?d:0,h=c&&i?0:d,y=a<=0?0:n.multiLineOffset(r);return Math.round(o===f?l:o===m?h-y:.5*(d-y))}function ke(e,t,n,r){t.x+=n,t.y+=r,t.bounds.translate(n,r),t.mark.bounds.translate(n,r),e.dirty(t)}function Me(e){t.Transform.call(this,null,e)}r.inherits(Me,t.Transform).transform=function(e,t){var r=t.dataflow;return e.mark.items.forEach((function(t){e.layout&&fe(r,t,e.layout),function(e,t,r){var u,c,d,l,h,y=t.items,b=Math.max(0,t.width||0),D=Math.max(0,t.height||0),I=(new n.Bounds).set(0,0,b,D),P=I.clone(),C=I.clone(),F=[];for(l=0,h=y.length;l<h;++l)switch((c=y[l]).role){case g:(oe(c)?P:C).union(ae(e,c,b,D));break;case p:u=c;break;case k:F.push(we(e,c));break;case w:case v:case M:case E:case T:case _:case A:case z:P.union(c.bounds),C.union(c.bounds);break;default:I.union(c.bounds)}if(F.length){const t={};F.forEach(e=>{(d=e.orient||i)!==L&&(t[d]||(t[d]=[])).push(e)});for(let n in t){const o=t[n];le(e,o,pe(o,n,r.legends,P,C,b,D))}F.forEach(t=>{const n=t.bounds;if(n.equals(t._bounds)||(t.bounds=t._bounds,e.dirty(t),t.bounds=n,e.dirty(t)),r.autosize&&r.autosize.type===O)switch(t.orient){case a:case i:I.add(n.x1,0).add(n.x2,0);break;case o:case s:I.add(0,n.y1).add(0,n.y2)}else I.union(n)})}I.union(P).union(C),u&&I.union(function(e,t,n,r,u){var c,d=t.items[0],l=d.frame,h=d.orient,y=d.anchor,b=d.offset,g=d.padding,p=d.items[0].items[0],w=d.items[1]&&d.items[1].items[0],v=h===a||h===i?r:n,k=0,M=0,E=0,T=0,_=0;if(l!==x?h===a?(k=u.y2,v=u.y1):h===i?(k=u.y1,v=u.y2):(k=u.x1,v=u.x2):h===a&&(k=r,v=0),c=y===f?k:y===m?v:(k+v)/2,w&&w.text){switch(h){case o:case s:_=p.bounds.height()+g;break;case a:T=p.bounds.width()+g;break;case i:T=-p.bounds.width()-g}te.clear().union(w.bounds),te.translate(T-(w.x||0),_-(w.y||0)),ne(w,"x",T)|ne(w,"y",_)&&(e.dirty(w),w.bounds.clear().union(te),w.mark.bounds.clear().union(te),e.dirty(w)),te.clear().union(w.bounds)}else te.clear();switch(te.union(p.bounds),h){case o:M=c,E=u.y1-te.height()-b;break;case a:M=u.x1-te.width()-b,E=c;break;case i:M=u.x2+te.width()+b,E=c;break;case s:M=c,E=u.y2+b;break;default:M=d.x,E=d.y}return ne(d,"x",M)|ne(d,"y",E)&&(te.translate(M,E),e.dirty(d),d.bounds.clear().union(te),t.bounds.clear().union(te),e.dirty(d)),d.bounds}(e,u,b,D,I));t.clip&&I.set(0,0,t.width||0,t.height||0);!function(e,t,n,r){var o=r.autosize||{},a=o.type,i=e._width,s=e._height,u=e.padding();if(e._autosize<1||!a)return;var c=Math.max(0,t.width||0),d=Math.max(0,Math.ceil(-n.x1)),l=Math.max(0,Math.ceil(n.x2-c)),f=Math.max(0,t.height||0),h=Math.max(0,Math.ceil(-n.y1)),m=Math.max(0,Math.ceil(n.y2-f));o.contains===B&&(i-=u.left+u.right,s-=u.top+u.bottom);a===L?(d=0,h=0,c=i,f=s):a===O?(c=Math.max(0,i-d-l),f=Math.max(0,s-h-m)):a===j?(c=Math.max(0,i-d-l),s=f+h+m):a===q?(i=c+d+l,f=Math.max(0,s-h-m)):a===S&&(i=c+d+l,s=f+h+m);e._resizeView(i,s,c,f,[d,h],o.resize)}(e,t,I,r)}(r,t,e)})),e.modified()&&t.reflow(),t},e.bound=H,e.identifier=V,e.mark=W,e.overlap=J,e.render=ee,e.viewlayout=Me,Object.defineProperty(e,"__esModule",{value:!0})}));