"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.setPreviouslyFocusedElement = exports.char_idx_to_js_idx = exports.js_idx_to_char_idx = exports.executionTime = exports.EmptyMessage = exports.rowRangeForCodeFoldAtBufferRow = exports.hotReloadPackage = exports.log = exports.getEditorDirectory = exports.getEmbeddedScope = exports.kernelSpecProvidesGrammar = exports.isUnsavedFilePath = exports.isMultilanguageGrammar = exports.msgSpecV4toV5 = exports.msgSpecToNotebookFormat = exports.grammarToLanguage = exports.openOrShowDock = exports.focus = exports.reactFactory = exports.NO_EXECTIME_STRING = exports.KERNEL_MONITOR_URI = exports.OUTPUT_AREA_URI = exports.WATCHES_URI = exports.INSPECTOR_URI = void 0;
const atom_1 = require("atom");
const react_1 = __importDefault(require("react"));
const react_dom_1 = __importDefault(require("react-dom"));
const lodash_1 = __importDefault(require("lodash"));
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const config_1 = __importDefault(require("./config"));
const store_1 = __importDefault(require("./store"));
exports.INSPECTOR_URI = "atom://hydrogen/inspector";
exports.WATCHES_URI = "atom://hydrogen/watch-sidebar";
exports.OUTPUT_AREA_URI = "atom://hydrogen/output-area";
exports.KERNEL_MONITOR_URI = "atom://hydrogen/kernel-monitor";
exports.NO_EXECTIME_STRING = "Not available";
function reactFactory(reactElement, domElement, additionalTeardown, disposer = store_1.default.subscriptions) {
    react_dom_1.default.render(reactElement, domElement);
    const disposable = new atom_1.Disposable(() => {
        react_dom_1.default.unmountComponentAtNode(domElement);
        if (typeof additionalTeardown === "function") {
            additionalTeardown();
        }
    });
    disposer.add(disposable);
}
exports.reactFactory = reactFactory;
function focus(item) {
    if (item && typeof item === "object") {
        const editorPane = atom.workspace.paneForItem(item);
        if (editorPane) {
            editorPane.activate();
        }
    }
}
exports.focus = focus;
async function openOrShowDock(URI) {
    let dock = atom.workspace.paneContainerForURI(URI);
    if (dock && typeof dock.show === "function") {
        const pane = atom.workspace.paneForURI(URI);
        if (pane) {
            pane.activateItemForURI(URI);
        }
        return dock.show();
    }
    await atom.workspace.open(URI, {
        searchAllPanes: true,
        activatePane: false,
    });
    dock = atom.workspace.paneContainerForURI(URI);
    return dock && typeof dock.show === "function" ? dock.show() : null;
}
exports.openOrShowDock = openOrShowDock;
function grammarToLanguage(grammar) {
    if (!grammar) {
        return null;
    }
    const grammarLanguage = grammar.name.toLowerCase();
    const mappings = config_1.default.getJson("languageMappings");
    const kernelLanguage = lodash_1.default.findKey(mappings, (l) => l.toLowerCase() === grammarLanguage);
    return kernelLanguage ? kernelLanguage.toLowerCase() : grammarLanguage;
}
exports.grammarToLanguage = grammarToLanguage;
function msgSpecToNotebookFormat(message) {
    return Object.assign({}, message.content, {
        output_type: message.header.msg_type,
    });
}
exports.msgSpecToNotebookFormat = msgSpecToNotebookFormat;
function msgSpecV4toV5(message) {
    switch (message.header.msg_type) {
        case "pyout":
            message.header.msg_type = "execute_result";
            break;
        case "pyerr":
            message.header.msg_type = "error";
            break;
        case "stream":
            if (!message.content.text) {
                message.content.text = message.content.data;
            }
            break;
    }
    return message;
}
exports.msgSpecV4toV5 = msgSpecV4toV5;
const markupGrammars = new Set([
    "source.gfm",
    "source.asciidoc",
    "text.restructuredtext",
    "text.tex.latex.knitr",
    "text.md",
    "source.weave.noweb",
    "source.weave.md",
    "source.weave.latex",
    "source.weave.restructuredtext",
    "source.pweave.noweb",
    "source.pweave.md",
    "source.pweave.latex",
    "source.pweave.restructuredtext",
    "source.dyndoc.md.stata",
    "source.dyndoc.latex.stata",
]);
function isMultilanguageGrammar(grammar) {
    return markupGrammars.has(grammar.scopeName);
}
exports.isMultilanguageGrammar = isMultilanguageGrammar;
const isUnsavedFilePath = (filePath) => {
    return filePath.match(/Unsaved\sEditor\s\d+/) ? true : false;
};
exports.isUnsavedFilePath = isUnsavedFilePath;
function kernelSpecProvidesGrammar(kernelSpec, grammar) {
    if (!grammar || !grammar.name || !kernelSpec || !kernelSpec.language) {
        return false;
    }
    const grammarLanguage = grammar.name.toLowerCase();
    const kernelLanguage = kernelSpec.language.toLowerCase();
    if (kernelLanguage === grammarLanguage) {
        return true;
    }
    const mappedLanguage = config_1.default.getJson("languageMappings")[kernelLanguage];
    if (!mappedLanguage) {
        return false;
    }
    return mappedLanguage.toLowerCase() === grammarLanguage;
}
exports.kernelSpecProvidesGrammar = kernelSpecProvidesGrammar;
function getEmbeddedScope(editor, position) {
    const scopes = editor
        .scopeDescriptorForBufferPosition(position)
        .getScopesArray();
    return lodash_1.default.find(scopes, (s) => s.indexOf("source.embedded.") === 0);
}
exports.getEmbeddedScope = getEmbeddedScope;
function getEditorDirectory(editor) {
    if (!editor) {
        return os_1.default.homedir();
    }
    const editorPath = editor.getPath();
    return editorPath ? path_1.default.dirname(editorPath) : os_1.default.homedir();
}
exports.getEditorDirectory = getEditorDirectory;
function log(...message) {
    if (atom.config.get("Hydrogen.debug")) {
        console.log("Hydrogen:", ...message);
    }
}
exports.log = log;
function hotReloadPackage() {
    const packName = "Hydrogen";
    const packPath = atom.packages.resolvePackagePath(packName);
    if (!packPath) {
        return;
    }
    const packPathPrefix = packPath + path_1.default.sep;
    const zeromqPathPrefix = path_1.default.join(packPath, "node_modules", "zeromq") + path_1.default.sep;
    log(`deactivating ${packName}`);
    atom.packages.deactivatePackage(packName);
    atom.packages.unloadPackage(packName);
    const packageLibsExceptZeromq = (filePath) => filePath.startsWith(packPathPrefix) &&
        !filePath.startsWith(zeromqPathPrefix);
    Object.keys(require.cache)
        .filter(packageLibsExceptZeromq)
        .forEach((filePath) => delete require.cache[filePath]);
    atom.packages.loadPackage(packName);
    atom.packages.activatePackage(packName);
    log(`activated ${packName}`);
}
exports.hotReloadPackage = hotReloadPackage;
function rowRangeForCodeFoldAtBufferRow(editor, row) {
    if (parseFloat(atom.getVersion()) < 1.22) {
        return editor.languageMode.rowRangeForCodeFoldAtBufferRow(row);
    }
    else {
        const range = editor.tokenizedBuffer.getFoldableRangeContainingPoint(new atom_1.Point(row, Infinity), editor.getTabLength());
        return range ? [range.start.row, range.end.row] : null;
    }
}
exports.rowRangeForCodeFoldAtBufferRow = rowRangeForCodeFoldAtBufferRow;
const EmptyMessage = () => {
    return (react_1.default.createElement("ul", { className: "background-message centered" },
        react_1.default.createElement("li", null, "No output to display")));
};
exports.EmptyMessage = EmptyMessage;
function executionTime(message) {
    if (!message.parent_header.date || !message.header.date) {
        return exports.NO_EXECTIME_STRING;
    }
    const start = Date.parse(message.parent_header.date);
    const end = Date.parse(message.header.date);
    const time = end - start;
    let sec = time / 1000;
    if (sec < 60) {
        return `${sec.toFixed(3)} sec`;
    }
    let min = (sec - (sec % 60)) / 60;
    sec = Math.round(sec % 60);
    if (min < 60) {
        return `${min} min ${sec} sec`;
    }
    const hour = (min - (min % 60)) / 60;
    min %= 60;
    return `${hour} h ${min} m ${sec} s`;
}
exports.executionTime = executionTime;
function js_idx_to_char_idx(js_idx, text) {
    if (text === null) {
        return -1;
    }
    let char_idx = js_idx;
    for (let i = 0; i < text.length && i < js_idx; i++) {
        const char_code = text.charCodeAt(i);
        if (char_code >= 0xd800 && char_code < 0xdc00) {
            char_idx -= 1;
        }
    }
    return char_idx;
}
exports.js_idx_to_char_idx = js_idx_to_char_idx;
function char_idx_to_js_idx(char_idx, text) {
    if (text === null) {
        return -1;
    }
    let js_idx = char_idx;
    for (let i = 0; i < text.length && i < js_idx; i++) {
        const char_code = text.charCodeAt(i);
        if (char_code >= 0xd800 && char_code < 0xdc00) {
            js_idx += 1;
        }
    }
    return js_idx;
}
exports.char_idx_to_js_idx = char_idx_to_js_idx;
function setPreviouslyFocusedElement(obj) {
    const activeElement = document.activeElement;
    if (activeElement instanceof HTMLElement) {
        obj.previouslyFocusedElement = activeElement;
    }
}
exports.setPreviouslyFocusedElement = setPreviouslyFocusedElement;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvdXRpbHMudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLCtCQU9jO0FBQ2Qsa0RBQTBCO0FBQzFCLDBEQUFpQztBQUNqQyxvREFBdUI7QUFDdkIsNENBQW9CO0FBQ3BCLGdEQUF3QjtBQUN4QixzREFBOEI7QUFDOUIsb0RBQTRCO0FBSWYsUUFBQSxhQUFhLEdBQUcsMkJBQTJCLENBQUM7QUFDNUMsUUFBQSxXQUFXLEdBQUcsK0JBQStCLENBQUM7QUFDOUMsUUFBQSxlQUFlLEdBQUcsNkJBQTZCLENBQUM7QUFDaEQsUUFBQSxrQkFBa0IsR0FBRyxnQ0FBZ0MsQ0FBQztBQUN0RCxRQUFBLGtCQUFrQixHQUFHLGVBQWUsQ0FBQztBQUNsRCxTQUFnQixZQUFZLENBQzFCLFlBQWdFLEVBQ2hFLFVBQXVCLEVBQ3ZCLGtCQUFzRSxFQUN0RSxXQUFnQyxlQUFLLENBQUMsYUFBYTtJQUVuRCxtQkFBUSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDMUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxpQkFBVSxDQUFDLEdBQUcsRUFBRTtRQUNyQyxtQkFBUSxDQUFDLHNCQUFzQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzVDLElBQUksT0FBTyxrQkFBa0IsS0FBSyxVQUFVLEVBQUU7WUFDNUMsa0JBQWtCLEVBQUUsQ0FBQztTQUN0QjtJQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0gsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMzQixDQUFDO0FBZEQsb0NBY0M7QUFDRCxTQUFnQixLQUFLLENBQUMsSUFBZ0M7SUFDcEQsSUFBSSxJQUFJLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQ3BDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELElBQUksVUFB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R0FBRyxRQUFRLENBQUM7SUFFdEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNsRCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBR3JDLElBQUksU0FBUyxJQUFJLE1BQU0sSUFBSSxTQUFTLEdBQUcsTUFBTSxFQUFFO1lBQzdDLE1BQU0sSUFBSSxDQUFDLENBQUM7U0FDYjtLQUNGO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQWhCRCxnREFnQkM7QUFNRCxTQUFnQiwyQkFBMkIsQ0FBQyxHQUUzQztJQUNDLE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUM7SUFDN0MsSUFBSSxhQUFhLFlBQVksV0FBVyxFQUFFO1FBQ3hDLEdBQUcsQ0FBQyx3QkFBd0IsR0FBRyxhQUFhLENBQUM7S0FDOUM7QUFDSCxDQUFDO0FBUEQsa0VBT0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIFRleHRFZGl0b3IsXHJcbiAgQ29tcG9zaXRlRGlzcG9zYWJsZSxcclxuICBEaXNwb3NhYmxlLFxyXG4gIFBvaW50LFxyXG4gIEdyYW1tYXIsXHJcbiAgRG9jayxcclxufSBmcm9tIFwiYXRvbVwiO1xyXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XHJcbmltcG9ydCBSZWFjdERPTSBmcm9tIFwicmVhY3QtZG9tXCI7XHJcbmltcG9ydCBfIGZyb20gXCJsb2Rhc2hcIjtcclxuaW1wb3J0IG9zIGZyb20gXCJvc1wiO1xyXG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xyXG5pbXBvcnQgQ29uZmlnIGZyb20gXCIuL2NvbmZpZ1wiO1xyXG5pbXBvcnQgc3RvcmUgZnJvbSBcIi4vc3RvcmVcIjtcclxuaW1wb3J0IHR5cGUgeyBNZXNzYWdlIH0gZnJvbSBcIi4vaHlkcm9nZW5cIjtcclxuaW1wb3J0IHR5cGUgeyBLZXJuZWxzcGVjTWV0YWRhdGEgfSBmcm9tIFwiQG50ZXJhY3QvdHlwZXNcIjtcclxuXHJcbmV4cG9ydCBjb25zdCBJTlNQRUNUT1JfVVJJID0gXCJhdG9tOi8vaHlkcm9nZW4vaW5zcGVjdG9yXCI7XHJcbmV4cG9ydCBjb25zdCBXQVRDSEVTX1VSSSA9IFwiYXRvbTovL2h5ZHJvZ2VuL3dhdGNoLXNpZGViYXJcIjtcclxuZXhwb3J0IGNvbnN0IE9VVFBVVF9BUkVBX1VSSSA9IFwiYXRvbTovL2h5ZHJvZ2VuL291dHB1dC1hcmVhXCI7XHJcbmV4cG9ydCBjb25zdCBLRVJORUxfTU9OSVRPUl9VUkkgPSBcImF0b206Ly9oeWRyb2dlbi9rZXJuZWwtbW9uaXRvclwiO1xyXG5leHBvcnQgY29uc3QgTk9fRVhFQ1RJTUVfU1RSSU5HID0gXCJOb3QgYXZhaWxhYmxlXCI7XHJcbmV4cG9ydCBmdW5jdGlvbiByZWFjdEZhY3RvcnkoXHJcbiAgcmVhY3RFbGVtZW50OiBSZWFjdC5SZWFjdEVsZW1lbnQ8UmVhY3QuQ29tcG9uZW50UHJvcHM8YW55PiwgYW55PixcclxuICBkb21FbGVtZW50OiBIVE1MRWxlbWVudCxcclxuICBhZGRpdGlvbmFsVGVhcmRvd24/OiAoKC4uLmFyZ3M6IEFycmF5PGFueT4pID0+IGFueSkgfCBudWxsIHwgdW5kZWZpbmVkLFxyXG4gIGRpc3Bvc2VyOiBDb21wb3NpdGVEaXNwb3NhYmxlID0gc3RvcmUuc3Vic2NyaXB0aW9uc1xyXG4pIHtcclxuICBSZWFjdERPTS5yZW5kZXIocmVhY3RFbGVtZW50LCBkb21FbGVtZW50KTtcclxuICBjb25zdCBkaXNwb3NhYmxlID0gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xyXG4gICAgUmVhY3RET00udW5tb3VudENvbXBvbmVudEF0Tm9kZShkb21FbGVtZW50KTtcclxuICAgIGlmICh0eXBlb2YgYWRkaXRpb25hbFRlYXJkb3duID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgYWRkaXRpb25hbFRlYXJkb3duKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgZGlzcG9zZXIuYWRkKGRpc3Bvc2FibGUpO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBmb2N1cyhpdGVtOiB1bmtub3duIHwgbnVsbCB8IHVuZGVmaW5lZCkge1xyXG4gIGlmIChpdGVtICYmIHR5cGVvZiBpdGVtID09PSBcIm9iamVjdFwiKSB7XHJcbiAgICBjb25zdCBlZGl0b3JQYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0oaXRlbSk7XHJcbiAgICBpZiAoZWRpdG9yUGFuZSkge1xyXG4gICAgICBlZGl0b3JQYW5lLmFjdGl2YXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBvcGVuT3JTaG93RG9jayhcclxuICBVUkk6IHN0cmluZ1xyXG4pOiBQcm9taXNlPHZvaWQgfCBudWxsIHwgdW5kZWZpbmVkPiB7XHJcbiAgLy8gYXRvbS53b3Jrc3BhY2Uub3BlbihVUkkpIHdpbGwgYWN0aXZhdGUvZm9jdXMgdGhlIGRvY2sgYnkgZGVmYXVsdFxyXG4gIC8vIGRvY2sudG9nZ2xlKCkgb3IgZG9jay5zaG93KCkgd2lsbCBsZWF2ZSBmb2N1cyB3aGVyZXZlciBpdCB3YXNcclxuICAvLyB0aGlzIGZ1bmN0aW9uIGlzIGJhc2ljYWxseSB3b3Jrc3BhY2Uub3BlbiwgZXhjZXB0IGl0XHJcbiAgLy8gd2lsbCBub3QgZm9jdXMgdGhlIG5ld2x5IG9wZW5lZCBwYW5lXHJcbiAgbGV0IGRvY2sgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9yVVJJKFVSSSk7XHJcblxyXG4gIGlmIChkb2NrICYmIHR5cGVvZiBkb2NrLnNob3cgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgLy8gSWYgdGhlIHRhcmdldCBpdGVtIGFscmVhZHkgZXhpc3QsIGFjdGl2YXRlIGl0IGFuZCBzaG93IGRvY2tcclxuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lRm9yVVJJKFVSSSk7XHJcbiAgICBpZiAocGFuZSkge1xyXG4gICAgICBwYW5lLmFjdGl2YXRlSXRlbUZvclVSSShVUkkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIChkb2NrIGFzIERvY2spLnNob3coKTtcclxuICB9XHJcblxyXG4gIGF3YWl0IGF0b20ud29ya3NwYWNlLm9wZW4oVVJJLCB7XHJcbiAgICBzZWFyY2hBbGxQYW5lczogdHJ1ZSxcclxuICAgIGFjdGl2YXRlUGFuZTogZmFsc2UsXHJcbiAgfSk7XHJcbiAgZG9jayA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JVUkkoVVJJKTtcclxuICByZXR1cm4gZG9jayAmJiB0eXBlb2YgZG9jay5zaG93ID09PSBcImZ1bmN0aW9uXCIgPyAoZG9jayBhcyBEb2NrKS5zaG93KCkgOiBudWxsO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBncmFtbWFyVG9MYW5ndWFnZShncmFtbWFyOiBHcmFtbWFyIHwgbnVsbCB8IHVuZGVmaW5lZCkge1xyXG4gIGlmICghZ3JhbW1hcikge1xyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIGNvbnN0IGdyYW1tYXJMYW5ndWFnZSA9IGdyYW1tYXIubmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gIGNvbnN0IG1hcHBpbmdzID0gQ29uZmlnLmdldEpzb24oXCJsYW5ndWFnZU1hcHBpbmdzXCIpO1xyXG5cclxuICBjb25zdCBrZXJuZWxMYW5ndWFnZSA9IF8uZmluZEtleShcclxuICAgIG1hcHBpbmdzLFxyXG4gICAgKGwpID0+IGwudG9Mb3dlckNhc2UoKSA9PT0gZ3JhbW1hckxhbmd1YWdlXHJcbiAgKTtcclxuXHJcbiAgcmV0dXJuIGtlcm5lbExhbmd1YWdlID8ga2VybmVsTGFuZ3VhZ2UudG9Mb3dlckNhc2UoKSA6IGdyYW1tYXJMYW5ndWFnZTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENvcGllZCBmcm9tXHJcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9udGVyYWN0L250ZXJhY3QvYmxvYi9tYXN0ZXIvc3JjL25vdGVib29rL2VwaWNzL2V4ZWN1dGUuanMjTDM3XHJcbiAqIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhZGhlcmVzIHRvIHRoZSBqdXB5dGVyIG5vdGVib29rIHNwZWNpZmljYXRpb24uXHJcbiAqIGh0dHA6Ly9qdXB5dGVyLWNsaWVudC5yZWFkdGhlZG9jcy5pby9lbi9sYXRlc3QvbWVzc2FnaW5nLmh0bWxcclxuICpcclxuICogQHBhcmFtIHtPYmplY3R9IG1zZyAtIE1lc3NhZ2UgdGhhdCBoYXMgY29udGVudCB3aGljaCBjYW4gYmUgY29udmVydGVkIHRvIG5iZm9ybWF0XHJcbiAqIEByZXR1cm5zIHtPYmplY3R9IEZvcm1hdHRlZE1zZyAtIE1lc3NhZ2Ugd2l0aCB0aGUgYXNzb2NpYXRlZCBvdXRwdXQgdHlwZVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIG1zZ1NwZWNUb05vdGVib29rRm9ybWF0KG1lc3NhZ2U6IE1lc3NhZ2UpIHtcclxuICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgbWVzc2FnZS5jb250ZW50LCB7XHJcbiAgICBvdXRwdXRfdHlwZTogbWVzc2FnZS5oZWFkZXIubXNnX3R5cGUsXHJcbiAgfSk7XHJcbn1cclxuXHJcbi8qKiBBIHZlcnkgYmFzaWMgY29udmVydGVyIGZvciBzdXBwb3J0aW5nIGp1cHl0ZXIgbWVzc2FnaW5nIHByb3RvY29sIHY0IHJlcGxpZXMgKi9cclxuZXhwb3J0IGZ1bmN0aW9uIG1zZ1NwZWNWNHRvVjUobWVzc2FnZTogTWVzc2FnZSkge1xyXG4gIHN3aXRjaCAobWVzc2FnZS5oZWFkZXIubXNnX3R5cGUpIHtcclxuICAgIGNhc2UgXCJweW91dFwiOlxyXG4gICAgICBtZXNzYWdlLmhlYWRlci5tc2dfdHlwZSA9IFwiZXhlY3V0ZV9yZXN1bHRcIjtcclxuICAgICAgYnJlYWs7XHJcblxyXG4gICAgY2FzZSBcInB5ZXJyXCI6XHJcbiAgICAgIG1lc3NhZ2UuaGVhZGVyLm1zZ190eXBlID0gXCJlcnJvclwiO1xyXG4gICAgICBicmVhaztcclxuXHJcbiAgICBjYXNlIFwic3RyZWFtXCI6XHJcbiAgICAgIGlmICghbWVzc2FnZS5jb250ZW50LnRleHQpIHtcclxuICAgICAgICBtZXNzYWdlLmNvbnRlbnQudGV4dCA9IG1lc3NhZ2UuY29udGVudC5kYXRhO1xyXG4gICAgICB9XHJcbiAgICAgIGJyZWFrO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIG1lc3NhZ2U7XHJcbn1cclxuY29uc3QgbWFya3VwR3JhbW1hcnMgPSBuZXcgU2V0KFtcclxuICBcInNvdXJjZS5nZm1cIixcclxuICBcInNvdXJjZS5hc2NpaWRvY1wiLFxyXG4gIFwidGV4dC5yZXN0cnVjdHVyZWR0ZXh0XCIsXHJcbiAgXCJ0ZXh0LnRleC5sYXRleC5rbml0clwiLFxyXG4gIFwidGV4dC5tZFwiLFxyXG4gIFwic291cmNlLndlYXZlLm5vd2ViXCIsXHJcbiAgXCJzb3VyY2Uud2VhdmUubWRcIixcclxuICBcInNvdXJjZS53ZWF2ZS5sYXRleFwiLFxyXG4gIFwic291cmNlLndlYXZlLnJlc3RydWN0dXJlZHRleHRcIixcclxuICBcInNvdXJjZS5wd2VhdmUubm93ZWJcIixcclxuICBcInNvdXJjZS5wd2VhdmUubWRcIixcclxuICBcInNvdXJjZS5wd2VhdmUubGF0ZXhcIixcclxuICBcInNvdXJjZS5wd2VhdmUucmVzdHJ1Y3R1cmVkdGV4dFwiLFxyXG4gIFwic291cmNlLmR5bmRvYy5tZC5zdGF0YVwiLFxyXG4gIFwic291cmNlLmR5bmRvYy5sYXRleC5zdGF0YVwiLFxyXG5dKTtcclxuZXhwb3J0IGZ1bmN0aW9uIGlzTXVsdGlsYW5ndWFnZUdyYW1tYXIoZ3JhbW1hcjogR3JhbW1hcikge1xyXG4gIHJldHVybiBtYXJrdXBHcmFtbWFycy5oYXMoZ3JhbW1hci5zY29wZU5hbWUpO1xyXG59XHJcbmV4cG9ydCBjb25zdCBpc1Vuc2F2ZWRGaWxlUGF0aCA9IChmaWxlUGF0aDogc3RyaW5nKTogYm9vbGVhbiA9PiB7XHJcbiAgcmV0dXJuIGZpbGVQYXRoLm1hdGNoKC9VbnNhdmVkXFxzRWRpdG9yXFxzXFxkKy8pID8gdHJ1ZSA6IGZhbHNlO1xyXG59O1xyXG5leHBvcnQgZnVuY3Rpb24ga2VybmVsU3BlY1Byb3ZpZGVzR3JhbW1hcihcclxuICBrZXJuZWxTcGVjOiBLZXJuZWxzcGVjTWV0YWRhdGEsXHJcbiAgZ3JhbW1hcjogR3JhbW1hciB8IG51bGwgfCB1bmRlZmluZWRcclxuKSB7XHJcbiAgaWYgKCFncmFtbWFyIHx8ICFncmFtbWFyLm5hbWUgfHwgIWtlcm5lbFNwZWMgfHwgIWtlcm5lbFNwZWMubGFuZ3VhZ2UpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGdyYW1tYXJMYW5ndWFnZSA9IGdyYW1tYXIubmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gIGNvbnN0IGtlcm5lbExhbmd1YWdlID0ga2VybmVsU3BlYy5sYW5ndWFnZS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICBpZiAoa2VybmVsTGFuZ3VhZ2UgPT09IGdyYW1tYXJMYW5ndWFnZSkge1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBjb25zdCBtYXBwZWRMYW5ndWFnZSA9IENvbmZpZy5nZXRKc29uKFwibGFuZ3VhZ2VNYXBwaW5nc1wiKVtrZXJuZWxMYW5ndWFnZV07XHJcblxyXG4gIGlmICghbWFwcGVkTGFuZ3VhZ2UpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHJldHVybiBtYXBwZWRMYW5ndWFnZS50b0xvd2VyQ2FzZSgpID09PSBncmFtbWFyTGFuZ3VhZ2U7XHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEVtYmVkZGVkU2NvcGUoXHJcbiAgZWRpdG9yOiBUZXh0RWRpdG9yLFxyXG4gIHBvc2l0aW9uOiBQb2ludFxyXG4pOiBzdHJpbmcgfCBudWxsIHwgdW5kZWZpbmVkIHtcclxuICBjb25zdCBzY29wZXMgPSBlZGl0b3JcclxuICAgIC5zY29wZURlc2NyaXB0b3JGb3JCdWZmZXJQb3NpdGlvbihwb3NpdGlvbilcclxuICAgIC5nZXRTY29wZXNBcnJheSgpO1xyXG4gIHJldHVybiBfLmZpbmQoc2NvcGVzLCAocykgPT4gcy5pbmRleE9mKFwic291cmNlLmVtYmVkZGVkLlwiKSA9PT0gMCk7XHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEVkaXRvckRpcmVjdG9yeShlZGl0b3I6IFRleHRFZGl0b3IgfCBudWxsIHwgdW5kZWZpbmVkKSB7XHJcbiAgaWYgKCFlZGl0b3IpIHtcclxuICAgIHJldHVybiBvcy5ob21lZGlyKCk7XHJcbiAgfVxyXG4gIGNvbnN0IGVkaXRvclBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpO1xyXG4gIHJldHVybiBlZGl0b3JQYXRoID8gcGF0aC5kaXJuYW1lKGVkaXRvclBhdGgpIDogb3MuaG9tZWRpcigpO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBsb2coLi4ubWVzc2FnZTogQXJyYXk8YW55Pikge1xyXG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoXCJIeWRyb2dlbi5kZWJ1Z1wiKSkge1xyXG4gICAgY29uc29sZS5sb2coXCJIeWRyb2dlbjpcIiwgLi4ubWVzc2FnZSk7XHJcbiAgfVxyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBob3RSZWxvYWRQYWNrYWdlKCkge1xyXG4gIGNvbnN0IHBhY2tOYW1lID0gXCJIeWRyb2dlblwiO1xyXG4gIGNvbnN0IHBhY2tQYXRoID0gYXRvbS5wYWNrYWdlcy5yZXNvbHZlUGFja2FnZVBhdGgocGFja05hbWUpO1xyXG4gIGlmICghcGFja1BhdGgpIHtcclxuICAgIHJldHVybjtcclxuICB9XHJcbiAgY29uc3QgcGFja1BhdGhQcmVmaXggPSBwYWNrUGF0aCArIHBhdGguc2VwO1xyXG4gIGNvbnN0IHplcm9tcVBhdGhQcmVmaXggPVxyXG4gICAgcGF0aC5qb2luKHBhY2tQYXRoLCBcIm5vZGVfbW9kdWxlc1wiLCBcInplcm9tcVwiKSArIHBhdGguc2VwO1xyXG4gIGxvZyhgZGVhY3RpdmF0aW5nICR7cGFja05hbWV9YCk7XHJcbiAgYXRvbS5wYWNrYWdlcy5kZWFjdGl2YXRlUGFja2FnZShwYWNrTmFtZSk7XHJcbiAgYXRvbS5wYWNrYWdlcy51bmxvYWRQYWNrYWdlKHBhY2tOYW1lKTtcclxuXHJcbiAgLy8gRGVsZXRlIHJlcXVpcmUgY2FjaGUgdG8gcmUtcmVxdWlyZSBvbiBhY3RpdmF0aW9uLlxyXG4gIC8vIEJ1dCBleGNlcHQgemVyb21xIG5hdGl2ZSBtb2R1bGUgd2hpY2ggaXMgbm90IHJlLXJlcXVpcmVhYmxlLlxyXG4gIGNvbnN0IHBhY2thZ2VMaWJzRXhjZXB0WmVyb21xID0gKGZpbGVQYXRoKSA9PlxyXG4gICAgZmlsZVBhdGguc3RhcnRzV2l0aChwYWNrUGF0aFByZWZpeCkgJiZcclxuICAgICFmaWxlUGF0aC5zdGFydHNXaXRoKHplcm9tcVBhdGhQcmVmaXgpO1xyXG5cclxuICBPYmplY3Qua2V5cyhyZXF1aXJlLmNhY2hlKVxyXG4gICAgLmZpbHRlcihwYWNrYWdlTGlic0V4Y2VwdFplcm9tcSlcclxuICAgIC5mb3JFYWNoKChmaWxlUGF0aCkgPT4gZGVsZXRlIHJlcXVpcmUuY2FjaGVbZmlsZVBhdGhdKTtcclxuICBhdG9tLnBhY2thZ2VzLmxvYWRQYWNrYWdlKHBhY2tOYW1lKTtcclxuICBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZShwYWNrTmFtZSk7XHJcbiAgbG9nKGBhY3RpdmF0ZWQgJHtwYWNrTmFtZX1gKTtcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gcm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KFxyXG4gIGVkaXRvcjogVGV4dEVkaXRvcixcclxuICByb3c6IG51bWJlclxyXG4pIHtcclxuICBpZiAocGFyc2VGbG9hdChhdG9tLmdldFZlcnNpb24oKSkgPCAxLjIyKSB7XHJcbiAgICByZXR1cm4gZWRpdG9yLmxhbmd1YWdlTW9kZS5yb3dSYW5nZUZvckNvZGVGb2xkQXRCdWZmZXJSb3cocm93KTtcclxuICB9IGVsc2Uge1xyXG4gICAgLy8gJEZsb3dGaXhNZVxyXG4gICAgY29uc3QgcmFuZ2UgPSBlZGl0b3IudG9rZW5pemVkQnVmZmVyLmdldEZvbGRhYmxlUmFuZ2VDb250YWluaW5nUG9pbnQoXHJcbiAgICAgIG5ldyBQb2ludChyb3csIEluZmluaXR5KSxcclxuICAgICAgZWRpdG9yLmdldFRhYkxlbmd0aCgpXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHJhbmdlID8gW3JhbmdlLnN0YXJ0LnJvdywgcmFuZ2UuZW5kLnJvd10gOiBudWxsO1xyXG4gIH1cclxufVxyXG5leHBvcnQgY29uc3QgRW1wdHlNZXNzYWdlID0gKCkgPT4ge1xyXG4gIHJldHVybiAoXHJcbiAgICA8dWwgY2xhc3NOYW1lPVwiYmFja2dyb3VuZC1tZXNzYWdlIGNlbnRlcmVkXCI+XHJcbiAgICAgIDxsaT5ObyBvdXRwdXQgdG8gZGlzcGxheTwvbGk+XHJcbiAgICA8L3VsPlxyXG4gICk7XHJcbn07XHJcbi8vIFRPRE86IHVzZSBucG0gcGFja2FnZSAtLSBtYXliZSBpdCBvZmZlcnMgbW9yZSByb2J1c3QgaW1wbGVtZW50YXRpb25cclxuXHJcbi8qKlxyXG4gKiBHaXZlbiBhIG1lc3NhZ2Ugd2hvc2UgdHlwZSBpZiBgZXhlY3V0ZV9yZXBseWAsIGNhbGN1bGF0ZXMgZXhlY3Rpb24gdGltZSBhbmRcclxuICogcmV0dXJucyBpdHMgc3RyaW5nIHJlcHJlc2VudGF0aW9uLlxyXG4gKlxyXG4gKiBAcGFyYW0ge01lc3NhZ2V9IG1lc3NhZ2UgLSBBIE1lc3NhZ2Ugb2JqZWN0IHdob3NlIHR5cGUgaXMgYGV4ZWN1dGVfcmVwbHlgXHJcbiAqIEByZXR1cm5zIHtTdHJpbmd9IC0gQSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGV4ZWN1dGlvbiB0aW1lLiBSZXR1cm5zXHJcbiAqICAgYE5PX0VYRUNUSU1FX1NUUklOR2AgaWYgZXhlY3V0aW9uIHRpbWUgaXMgdW5hdmFpbGFibGUuXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZXhlY3V0aW9uVGltZShtZXNzYWdlOiBNZXNzYWdlKTogc3RyaW5nIHtcclxuICBpZiAoIW1lc3NhZ2UucGFyZW50X2hlYWRlci5kYXRlIHx8ICFtZXNzYWdlLmhlYWRlci5kYXRlKSB7XHJcbiAgICByZXR1cm4gTk9fRVhFQ1RJTUVfU1RSSU5HO1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc3RhcnQgPSBEYXRlLnBhcnNlKG1lc3NhZ2UucGFyZW50X2hlYWRlci5kYXRlKTtcclxuICBjb25zdCBlbmQgPSBEYXRlLnBhcnNlKG1lc3NhZ2UuaGVhZGVyLmRhdGUpO1xyXG4gIGNvbnN0IHRpbWUgPSBlbmQgLSBzdGFydDsgLy8gbWlsbGlzZWNvbmRzXHJcblxyXG4gIGxldCBzZWMgPSB0aW1lIC8gMTAwMDsgLy8gc2Vjb25kc1xyXG5cclxuICBpZiAoc2VjIDwgNjApIHtcclxuICAgIHJldHVybiBgJHtzZWMudG9GaXhlZCgzKX0gc2VjYDtcclxuICB9XHJcblxyXG4gIGxldCBtaW4gPSAoc2VjIC0gKHNlYyAlIDYwKSkgLyA2MDtcclxuICBzZWMgPSBNYXRoLnJvdW5kKHNlYyAlIDYwKTtcclxuXHJcbiAgaWYgKG1pbiA8IDYwKSB7XHJcbiAgICByZXR1cm4gYCR7bWlufSBtaW4gJHtzZWN9IHNlY2A7XHJcbiAgfVxyXG5cclxuICBjb25zdCBob3VyID0gKG1pbiAtIChtaW4gJSA2MCkpIC8gNjA7XHJcbiAgbWluICU9IDYwO1xyXG4gIHJldHVybiBgJHtob3VyfSBoICR7bWlufSBtICR7c2VjfSBzYDtcclxufVxyXG5leHBvcnQgZnVuY3Rpb24ganNfaWR4X3RvX2NoYXJfaWR4KGpzX2lkeDogbnVtYmVyLCB0ZXh0OiBzdHJpbmcgfCBudWxsKSB7XHJcbiAgaWYgKHRleHQgPT09IG51bGwpIHtcclxuICAgIHJldHVybiAtMTtcclxuICB9XHJcbiAgbGV0IGNoYXJfaWR4ID0ganNfaWR4O1xyXG5cclxuICBmb3IgKGxldCBpID0gMDsgaSA8IHRleHQubGVuZ3RoICYmIGkgPCBqc19pZHg7IGkrKykge1xyXG4gICAgY29uc3QgY2hhcl9jb2RlID0gdGV4dC5jaGFyQ29kZUF0KGkpO1xyXG5cclxuICAgIC8vIGNoZWNrIGZvciB0aGUgZmlyc3QgaGFsZiBvZiBhIHN1cnJvZ2F0ZSBwYWlyXHJcbiAgICBpZiAoY2hhcl9jb2RlID49IDB4ZDgwMCAmJiBjaGFyX2NvZGUgPCAweGRjMDApIHtcclxuICAgICAgY2hhcl9pZHggLT0gMTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBjaGFyX2lkeDtcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gY2hhcl9pZHhfdG9fanNfaWR4KGNoYXJfaWR4OiBudW1iZXIsIHRleHQ6IHN0cmluZyB8IG51bGwpIHtcclxuICBpZiAodGV4dCA9PT0gbnVsbCkge1xyXG4gICAgcmV0dXJuIC0xO1xyXG4gIH1cclxuICBsZXQganNfaWR4ID0gY2hhcl9pZHg7XHJcblxyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdGV4dC5sZW5ndGggJiYgaSA8IGpzX2lkeDsgaSsrKSB7XHJcbiAgICBjb25zdCBjaGFyX2NvZGUgPSB0ZXh0LmNoYXJDb2RlQXQoaSk7XHJcblxyXG4gICAgLy8gY2hlY2sgZm9yIHRoZSBmaXJzdCBoYWxmIG9mIGEgc3Vycm9nYXRlIHBhaXJcclxuICAgIGlmIChjaGFyX2NvZGUgPj0gMHhkODAwICYmIGNoYXJfY29kZSA8IDB4ZGMwMCkge1xyXG4gICAgICBqc19pZHggKz0gMTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBqc19pZHg7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBTZXRzIHRoZSBgcHJldmlvdXNseUZvY3VzZWRFbGVtZW50YCBwcm9wZXJ0eSBvZiB0aGUgZ2l2ZW4gb2JqZWN0IHRvXHJcbiAqIGFjdGl2ZUVsZW1lbnQgaWYgaXQgaXMgYW4gSFRNTEVsZW1lbnRcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBzZXRQcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQob2JqOiB7XHJcbiAgcHJldmlvdXNseUZvY3VzZWRFbGVtZW50OiBIVE1MRWxlbWVudCB8IG51bGwgfCB1bmRlZmluZWQ7XHJcbn0pIHtcclxuICBjb25zdCBhY3RpdmVFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcclxuICBpZiAoYWN0aXZlRWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XHJcbiAgICBvYmoucHJldmlvdXNseUZvY3VzZWRFbGVtZW50ID0gYWN0aXZlRWxlbWVudDtcclxuICB9XHJcbn1cclxuIl19