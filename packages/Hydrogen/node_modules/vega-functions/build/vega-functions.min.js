!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-expression"),require("vega-dataflow"),require("vega-selections"),require("vega-statistics"),require("vega-util"),require("d3-array"),require("d3-color"),require("d3-format"),require("d3-time-format"),require("vega-scale"),require("d3-geo"),require("vega-scenegraph")):"function"==typeof define&&define.amd?define(["exports","vega-expression","vega-dataflow","vega-selections","vega-statistics","vega-util","d3-array","d3-color","d3-format","d3-time-format","vega-scale","d3-geo","vega-scenegraph"],e):e((t=t||self).vega={},t.vega,t.vega,t.vega,t.vega,t.vega,t.d3,t.d3,t.d3,t.d3,t.vega,t.d3,t.vega)}(this,(function(t,e,n,r,o,i,a,c,u,s,l,f,m){"use strict";function d(t){const e=t/255;return e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)}function g(t){const e=c.rgb(t);return.2126*d(e.r)+.7152*d(e.g)+.0722*d(e.b)}function p(t,e){const n=g(t),r=g(e);return(Math.max(n,r)+.05)/(Math.min(n,r)+.05)}function h(t){const e=this.context.data[t];return e?e.values.value:[]}function v(t,e,n){const r=this.context.data[t]["index:"+e],o=r?r.value.get(n):void 0;return o?o.count:o}function y(t,e){const n=this.context.dataflow,r=this.context.data[t].input;return n.pulse(r,n.changeset().remove(i.truthy).insert(e)),1}function b(t,e,n){if(t){const n=this.context.dataflow,r=t.mark.source;n.pulse(r,n.changeset().encode(t,e))}return void 0!==n?n:t}const x={};function w(t,e,n){let r=t+":"+n,o=x[r];return o&&o[0]===e||(x[r]=o=[e,e(n)]),o[1]}function P(t,e){return w("format",u.format,e)(t)}function S(t,e){return w("timeFormat",s.timeFormat,e)(t)}function q(t,e){return w("utcFormat",s.utcFormat,e)(t)}function L(t,e){return w("timeParse",s.timeParse,e)(t)}function F(t,e){return w("utcParse",s.utcParse,e)(t)}var N=new Date(2e3,0,1);function A(t,e,n){return Number.isInteger(t)&&Number.isInteger(e)?(N.setMonth(t),N.setDate(e),S(N,n)):""}function k(t){return A(t,1,"%B")}function D(t){return A(t,1,"%b")}function z(t){return A(0,2+t,"%A")}function R(t){return A(0,2+t,"%a")}function O(t,e){let n;return i.isFunction(t)?t:i.isString(t)?(n=e.scales[t])&&n.value:void 0}function B(t,e){const n=O(t,(e||this).context);return n&&n.range?n.range():[]}function j(t,e){const n=O(t,(e||this).context);return n?n.domain():[]}function U(t,e){const n=O(t,(e||this).context);return n&&n.bandwidth?n.bandwidth():0}function E(t,e,n){return l.bandSpace(t||0,e||0,n||0)}function M(t,e){const n=O(t,(e||this).context);return n?n.copy():void 0}function V(t,e,n){const r=O(t,(n||this).context);return r&&void 0!==e?r(e):void 0}function I(t,e,n){const r=O(t,(n||this).context);return r?i.isArray(e)?(r.invertRange||r.invert)(e):(r.invert||r.invertExtent)(e):void 0}function T(t,e){return function(n,r,o){if(n){const e=O(n,(o||this).context);return e&&e.path[t](r)}return e(r)}}const X=T("area",f.geoArea),_=T("bounds",f.geoBounds),C=T("centroid",f.geoCentroid);function Y(t){let e=this.context.group,n=!1;if(e)for(;t;){if(t===e){n=!0;break}t=t.mark.group}return n}function G(t,e,n){try{t[e].apply(t,["EXPRESSION"].concat([].slice.call(n)))}catch(e){t.warn(e)}return n[n.length-1]}function H(){return G(this.context.dataflow,"warn",arguments)}function W(){return G(this.context.dataflow,"info",arguments)}function $(){return G(this.context.dataflow,"debug",arguments)}function J(){var t=[].slice.call(arguments);return t.unshift({}),i.extend.apply(null,t)}function K(t,e){return t===e||t!=t&&e!=e||(i.isArray(t)?!(!i.isArray(e)||t.length!==e.length)&&function(t,e){for(let n=0,r=t.length;n<r;++n)if(!K(t[n],e[n]))return!1;return!0}(t,e):!(!i.isObject(t)||!i.isObject(e))&&Q(t,e))}function Q(t,e){for(let n in t)if(!K(t[n],e[n]))return!1;return!0}function Z(t){return e=>Q(t,e)}function tt(t,e,r,o,a,c){let u,s,l=this.context.dataflow,f=this.context.data[t],m=f.input,d=f.changes,g=l.stamp();if(!1===l._trigger||!(m.value.length||e||o))return 0;if((!d||d.stamp<g)&&(f.changes=d=l.changeset(),d.stamp=g,l.runAfter((function(){f.modified=!0,l.pulse(m,d).run()}),!0,1)),r&&(u=!0===r?i.truthy:i.isArray(r)||n.isTuple(r)?r:Z(r),d.remove(u)),e&&d.insert(e),o&&(u=Z(o),m.value.some(u)?d.remove(u):d.insert(o)),a)for(s in c)d.modify(a,s,c[s]);return 1}function et(t){const e=t.touches,n=e[0].clientX-e[1].clientX,r=e[0].clientY-e[1].clientY;return Math.sqrt(n*n+r*r)}function nt(t){const e=t.touches;return Math.atan2(e[0].clientY-e[1].clientY,e[0].clientX-e[1].clientX)}function rt(t,e,n,r,o){t=O(t,(o||this).context);const a=m.Gradient(e,n);let c=t.domain(),u=c[0],s=i.peek(c),f=i.identity;return s-u?f=l.scaleFraction(t,u,s):t=(t.interpolator?l.scale("sequential")().interpolator(t.interpolator()):l.scale("linear")().interpolate(t.interpolate()).range(t.range())).domain([u=0,s=1]),t.ticks&&(u!==(c=t.ticks(+r||15))[0]&&c.unshift(u),s!==i.peek(c)&&c.push(s)),c.forEach(e=>a.stop(f(e),t(e))),a}function ot(t,e,n){const r=O(t,(n||this).context);return function(t){return r?r.path.context(t)(e):""}}function it(t){let e=null;return function(n){return n?m.pathRender(n,e=e||m.pathParse(t)):t}}const at={};function ct(t){return t.data}function ut(t,e){const n=h.call(e,t);return n.root&&n.root.lookup||at}function st(t,e,n){const r=ut(t,this),o=r[e],i=r[n];return o&&i?o.path(i).map(ct):void 0}function lt(t,e){const n=ut(t,this)[e];return n?n.ancestors().map(ct):void 0}const ft="undefined"!=typeof window&&window||null;function mt(){return ft?ft.screen:{}}function dt(){return ft?[ft.innerWidth,ft.innerHeight]:[void 0,void 0]}function gt(){const t=this.context.dataflow,e=t.container&&t.container();return e?[e.clientWidth,e.clientHeight]:[void 0,void 0]}const pt=":",ht="@",vt="%";function yt(t,n,r,o){n[0].type!==e.Literal&&i.error("First argument to data functions must be a string literal.");const a=n[0].value,c=pt+a;if(!i.hasOwnProperty(c,o))try{o[c]=r.getData(a).tuplesRef()}catch(t){}}function bt(t,n,r,o){n[0].type!==e.Literal&&i.error("First argument to indata must be a string literal."),n[1].type!==e.Literal&&i.error("Second argument to indata must be a string literal.");const a=n[0].value,c=n[1].value,u=ht+c;i.hasOwnProperty(u,o)||(o[u]=r.getData(a).indataRef(r,c))}function xt(t,n,r,o){if(n[0].type===e.Literal)wt(r,o,n[0].value);else if(n[0].type===e.Identifier)for(t in r.scales)wt(r,o,t)}function wt(t,e,n){const r=vt+n;if(!i.hasOwnProperty(e,r))try{e[r]=t.scaleRef(n)}catch(t){}}const Pt={random:function(){return o.random()},cumulativeNormal:o.cumulativeNormal,cumulativeLogNormal:o.cumulativeLogNormal,cumulativeUniform:o.cumulativeUniform,densityNormal:o.densityNormal,densityLogNormal:o.densityLogNormal,densityUniform:o.densityUniform,quantileNormal:o.quantileNormal,quantileLogNormal:o.quantileLogNormal,quantileUniform:o.quantileUniform,sampleNormal:o.sampleNormal,sampleLogNormal:o.sampleLogNormal,sampleUniform:o.sampleUniform,isArray:i.isArray,isBoolean:i.isBoolean,isDate:i.isDate,isDefined:function(t){return void 0!==t},isNumber:i.isNumber,isObject:i.isObject,isRegExp:i.isRegExp,isString:i.isString,isTuple:n.isTuple,isValid:function(t){return null!=t&&t==t},toBoolean:i.toBoolean,toDate:i.toDate,toNumber:i.toNumber,toString:i.toString,flush:i.flush,lerp:i.lerp,merge:J,pad:i.pad,peek:i.peek,span:i.span,inrange:i.inrange,truncate:i.truncate,rgb:c.rgb,lab:c.lab,hcl:c.hcl,hsl:c.hsl,luminance:g,contrast:p,sequence:a.range,format:P,utcFormat:q,utcParse:F,timeFormat:S,timeParse:L,monthFormat:k,monthAbbrevFormat:D,dayFormat:z,dayAbbrevFormat:R,quarter:i.quarter,utcquarter:i.utcquarter,warn:H,info:W,debug:$,extent:i.extent,inScope:Y,intersect:function(t,e,n){if(!t)return[];const[r,o]=t,a=(new m.Bounds).set(r[0],r[1],o[0],o[1]),c=n||this.context.dataflow.scenegraph().root;return m.intersect(c,a,function(t){let e=null;if(t){const n=i.array(t.marktype),r=i.array(t.markname);e=t=>(!n.length||n.some(e=>t.marktype===e))&&(!r.length||r.some(e=>t.name===e))}return e}(e))},clampRange:i.clampRange,pinchDistance:et,pinchAngle:nt,screen:mt,containerSize:gt,windowSize:dt,bandspace:E,setdata:y,pathShape:it,panLinear:i.panLinear,panLog:i.panLog,panPow:i.panPow,panSymlog:i.panSymlog,zoomLinear:i.zoomLinear,zoomLog:i.zoomLog,zoomPow:i.zoomPow,zoomSymlog:i.zoomSymlog,encode:b,modify:tt},St=["view","item","group","xy","x","y"],qt="event.vega.",Lt="this.",Ft={};function Nt(t,e,n){return 1===arguments.length?Pt[t]:(Pt[t]=e,n&&(Ft[t]=n),kt&&(kt.functions[t]=Lt+t),this)}Nt("bandwidth",U,xt),Nt("copy",M,xt),Nt("domain",j,xt),Nt("range",B,xt),Nt("invert",I,xt),Nt("scale",V,xt),Nt("gradient",rt,xt),Nt("geoArea",X,xt),Nt("geoBounds",_,xt),Nt("geoCentroid",C,xt),Nt("geoShape",ot,xt),Nt("indata",v,bt),Nt("data",h,yt),Nt("treePath",st,yt),Nt("treeAncestors",lt,yt),Nt("vlSelectionTest",r.selectionTest,r.selectionVisitor),Nt("vlSelectionResolve",r.selectionResolve,r.selectionVisitor);const At={blacklist:["_"],whitelist:["datum","event","item"],fieldvar:"datum",globalvar:function(t){return"_["+i.stringValue("$"+t)+"]"},functions:function(t){const n=e.functions(t);St.forEach(t=>n[t]=qt+t);for(let t in Pt)n[t]=Lt+t;return n},constants:e.constants,visitors:Ft};var kt=e.codegen(At);Object.defineProperty(t,"formatLocale",{enumerable:!0,get:function(){return u.formatDefaultLocale}}),Object.defineProperty(t,"timeFormatLocale",{enumerable:!0,get:function(){return s.timeFormatDefaultLocale}}),t.DataPrefix=pt,t.IndexPrefix=ht,t.ScalePrefix=vt,t.SignalPrefix="$",t.bandspace=E,t.bandwidth=U,t.codeGenerator=kt,t.codegenParams=At,t.containerSize=gt,t.contrast=p,t.copy=M,t.data=h,t.dataVisitor=yt,t.dayAbbrevFormat=R,t.dayFormat=z,t.debug=$,t.domain=j,t.encode=b,t.expressionFunction=Nt,t.format=P,t.functionContext=Pt,t.geoArea=X,t.geoBounds=_,t.geoCentroid=C,t.geoShape=ot,t.inScope=Y,t.indata=v,t.indataVisitor=bt,t.info=W,t.invert=I,t.luminance=g,t.merge=J,t.modify=tt,t.monthAbbrevFormat=D,t.monthFormat=k,t.pathShape=it,t.pinchAngle=nt,t.pinchDistance=et,t.range=B,t.scale=V,t.scaleGradient=rt,t.scaleVisitor=xt,t.screen=mt,t.setdata=y,t.timeFormat=S,t.timeParse=L,t.treeAncestors=lt,t.treePath=st,t.utcFormat=q,t.utcParse=F,t.warn=H,t.windowSize=dt,Object.defineProperty(t,"__esModule",{value:!0})}));