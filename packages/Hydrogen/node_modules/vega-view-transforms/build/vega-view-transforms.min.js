!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util"],e):e(((t=t||self).vega=t.vega||{},t.vega.transforms={}),t.vega,t.vega,t.vega)}(this,function(t,e,n,r){"use strict";const o="top",a="left",i="right",s="bottom",u="top-left",c="top-right",d="bottom-left",l="bottom-right",f="start",h="middle",m="end",y="x",b="y",x="group",g="axis",p="title",w="frame",v="scope",k="legend",M="row-header",E="row-footer",T="row-title",_="column-header",A="column-footer",z="column-title",B="padding",D="symbol",O="fit",S="fit-x",j="fit-y",q="pad",I="none",P="all",C="each",F="flush",G="column",H="row";function L(t){e.Transform.call(this,null,t)}function R(t,e,n){return e(t.bounds.clear(),t,n)}r.inherits(L,e.Transform).transform=function(t,e){var r,o=e.dataflow,a=t.mark,i=a.marktype,s=n.Marks[i],u=s.bound,c=a.bounds;return s.nested?(a.items.length&&o.dirty(a.items[0]),c=R(a,u),a.items.forEach(function(t){t.bounds.clear().union(c)})):i===x||t.modified()?(e.visit(e.MOD,function(t){o.dirty(t)}),c.clear(),a.items.forEach(function(t){c.union(R(t,u))}),a.role===k&&e.reflow()):(r=e.changed(e.REM),e.visit(e.ADD,function(t){c.union(R(t,u))}),e.visit(e.MOD,function(t){r=r||c.alignsWith(t.bounds),o.dirty(t),c.union(R(t,u))}),r&&(c.clear(),a.items.forEach(function(t){c.union(t.bounds)}))),n.boundClip(a),e.modifies("bounds")};var U=":vega_identifier:";function V(t){e.Transform.call(this,0,t)}function W(t){e.Transform.call(this,null,t)}function J(t){e.Transform.call(this,null,t)}V.Definition={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]},r.inherits(V,e.Transform).transform=function(t,e){var n=function(t){var e=t._signals[U];e||(t._signals[U]=e=t.add(0));return e}(e.dataflow),r=n.value,o=t.as;return e.visit(e.ADD,function(t){t[o]||(t[o]=++r)}),n.set(this.value=r),e},r.inherits(W,e.Transform).transform=function(t,e){var r=this.value;r||((r=e.dataflow.scenegraph().mark(t.markdef,function(t){var e=t.groups,n=t.parent;return e&&1===e.size?e.get(Object.keys(e.object)[0]):e&&n?e.lookup(n):null}(t),t.index)).group.context=t.context,t.context.group||(t.context.group=r.group),r.source=this.source,r.clip=t.clip,r.interactive=t.interactive,this.value=r);var o=r.marktype===x?n.GroupItem:n.Item;return e.visit(e.ADD,function(t){o.call(t,r)}),(t.modified("clip")||t.modified("interactive"))&&(r.clip=t.clip,r.interactive=!!t.interactive,r.zdirty=!0,e.reflow()),r.items=e.source,e};var K=r.inherits(J,e.Transform),N={parity:function(t){return t.filter((t,e)=>e%2?t.opacity=0:1)},greedy:function(t,e){var n;return t.filter((t,r)=>r&&Q(n.bounds,t.bounds,e)?t.opacity=0:(n=t,1))}};function Q(t,e,n){return n>Math.max(e.x1-t.x2,t.x1-e.x2,e.y1-t.y2,t.y1-e.y2)}function X(t,e){for(var n,r=1,o=t.length,a=t[0].bounds;r<o;a=n,++r)if(Q(a,n=t[r].bounds,e))return!0}function Y(t){var e=t.bounds;return e.width()>1&&e.height()>1}function Z(t){return t.forEach(t=>t.opacity=1),t}function $(t,e){return t.reflow(e.modified()).modifies("opacity")}function tt(t){e.Transform.call(this,null,t)}K.transform=function(t,e){var a,i,u,c=N[t.method]||N.parity,d=e.materialize(e.SOURCE).source,l=t.separation||0;if(d&&d.length){if(!t.method)return t.modified("method")&&(Z(d),e=$(e,t)),e;if(t.sort&&(d=d.slice().sort(t.sort)),a=Z(d=d.filter(Y)),e=$(e,t),a.length>=3&&X(a,l)){do{a=c(a,l)}while(a.length>=3&&X(a,l));a.length<3&&!r.peek(d).opacity&&(a.length>1&&(r.peek(a).opacity=0),r.peek(d).opacity=1)}var f,h,m,y,b;return t.boundScale&&t.boundTolerance>=0&&(f=t.boundScale,h=t.boundOrient,m=+t.boundTolerance,y=f.range(),b=new n.Bounds,h===o||h===s?b.set(y[0],-1/0,y[1],1/0):b.set(-1/0,y[0],1/0,y[1]),b.expand(m||1),i=t=>b.encloses(t.bounds),d.forEach(t=>{i(t)||(t.opacity=0)})),u=a[0].mark.bounds.clear(),d.forEach(t=>{t.opacity&&u.union(t.bounds)}),e}},r.inherits(tt,e.Transform).transform=function(t,e){var n=e.dataflow;if(e.visit(e.ALL,function(t){n.dirty(t)}),e.fields&&e.fields.zindex){var r=e.source&&e.source[0];r&&(r.mark.zdirty=!0)}};const et=new n.Bounds;function nt(t,e,n){return t[e]===n?0:(t[e]=n,1)}const rt=.5;function ot(t){var e=t.items[0].datum.orient;return e===a||e===i}function at(t,e,r,u){var c,d,l=e.items[0],f=l.datum,h=f.orient,m=function(t){var e=+t.grid;return[t.ticks?e++:-1,t.labels?e++:-1,e+ +t.domain]}(f),y=l.range,b=l.offset,x=l.position,g=l.minExtent,p=l.maxExtent,w=f.title&&l.items[m[2]].items[0],v=l.titlePadding,k=l.bounds,M=0,E=0;switch(et.clear().union(k),k.clear(),(c=m[0])>-1&&k.union(l.items[c].bounds),(c=m[1])>-1&&k.union(l.items[c].bounds),h){case o:M=x||0,E=-b,d=Math.max(g,Math.min(p,-k.y1)),w&&(d=it(w,d,v,0,-1,k)),k.add(0,-d).add(y,0);break;case a:M=-b,E=x||0,d=Math.max(g,Math.min(p,-k.x1)),w&&(d=it(w,d,v,1,-1,k)),k.add(-d,0).add(0,y);break;case i:M=r+b,E=x||0,d=Math.max(g,Math.min(p,k.x2)),w&&(d=it(w,d,v,1,1,k)),k.add(0,0).add(d,y);break;case s:M=x||0,E=u+b,d=Math.max(g,Math.min(p,k.y2)),w&&(d=it(w,d,v,0,1,k)),k.add(0,0).add(y,d);break;default:M=l.x,E=l.y}return n.boundStroke(k.translate(M,E),l),nt(l,"x",M+rt)|nt(l,"y",E+rt)&&(l.bounds=et,t.dirty(l),l.bounds=k,t.dirty(l)),l.mark.bounds.clear().union(k)}function it(t,e,n,r,o,a){var i=t.bounds,s=0,u=0;return t.auto?(e+=n,r?s=(t.x||0)-(t.x=o*e):u=(t.y||0)-(t.y=o*e),i.translate(-s,-u),t.mark.bounds.set(i.x1,i.y1,i.x2,i.y2),r?(a.add(0,i.y1).add(0,i.y2),e+=i.width()):(a.add(i.x1,0).add(i.x2,0),e+=i.height())):a.union(i),e}function st(t){return(new n.Bounds).set(0,0,t.width||0,t.height||0)}function ut(t){var e=t.bounds.clone();return e.empty()?e.set(0,0,0,0):e.translate(-(t.x||0),-(t.y||0))}function ct(t,e,n){var o=r.isObject(t)?t[e]:t;return null!=o?o:void 0!==n?n:0}function dt(t){return t<0?Math.ceil(-t):0}function lt(t,e,n){var r,o,a,i,s,u,c,d,l,f,x,g=!n.nodirty,p=n.bounds===F?st:ut,w=et.set(0,0,0,0),v=ct(n.align,G),k=ct(n.align,H),M=ct(n.padding,G),E=ct(n.padding,H),T=n.columns||e.length,_=T<0?1:Math.ceil(e.length/T),A=e.length,z=Array(A),B=Array(T),D=0,O=Array(A),S=Array(_),j=0,q=Array(A),I=Array(A),L=Array(A);for(o=0;o<T;++o)B[o]=0;for(o=0;o<_;++o)S[o]=0;for(o=0;o<A;++o)u=e[o],s=L[o]=p(u),u.x=u.x||0,q[o]=0,u.y=u.y||0,I[o]=0,a=o%T,i=~~(o/T),D=Math.max(D,c=Math.ceil(s.x2)),j=Math.max(j,d=Math.ceil(s.y2)),B[a]=Math.max(B[a],c),S[i]=Math.max(S[i],d),z[o]=M+dt(s.x1),O[o]=E+dt(s.y1),g&&t.dirty(e[o]);for(o=0;o<A;++o)o%T==0&&(z[o]=0),o<T&&(O[o]=0);if(v===C)for(a=1;a<T;++a){for(x=0,o=a;o<A;o+=T)x<z[o]&&(x=z[o]);for(o=a;o<A;o+=T)z[o]=x+B[a-1]}else if(v===P){for(x=0,o=0;o<A;++o)o%T&&x<z[o]&&(x=z[o]);for(o=0;o<A;++o)o%T&&(z[o]=x+D)}else for(v=!1,a=1;a<T;++a)for(o=a;o<A;o+=T)z[o]+=B[a-1];if(k===C)for(i=1;i<_;++i){for(x=0,r=(o=i*T)+T;o<r;++o)x<O[o]&&(x=O[o]);for(o=i*T;o<r;++o)O[o]=x+S[i-1]}else if(k===P){for(x=0,o=T;o<A;++o)x<O[o]&&(x=O[o]);for(o=T;o<A;++o)O[o]=x+j}else for(k=!1,i=1;i<_;++i)for(r=(o=i*T)+T;o<r;++o)O[o]+=S[i-1];for(l=0,o=0;o<A;++o)l=z[o]+(o%T?l:0),q[o]+=l-e[o].x;for(a=0;a<T;++a)for(f=0,o=a;o<A;o+=T)f+=O[o],I[o]+=f-e[o].y;if(v&&ct(n.center,G)&&_>1)for(o=0;o<A;++o)(l=(s=v===P?D:B[o%T])-L[o].x2-e[o].x-q[o])>0&&(q[o]+=l/2);if(k&&ct(n.center,H)&&1!==T)for(o=0;o<A;++o)(f=(s=k===P?j:S[~~(o/T)])-L[o].y2-e[o].y-I[o])>0&&(I[o]+=f/2);for(o=0;o<A;++o)w.union(L[o].translate(q[o],I[o]));switch(l=ct(n.anchor,y),f=ct(n.anchor,b),ct(n.anchor,G)){case m:l-=w.width();break;case h:l-=w.width()/2}switch(ct(n.anchor,H)){case m:f-=w.height();break;case h:f-=w.height()/2}for(l=Math.round(l),f=Math.round(f),w.clear(),o=0;o<A;++o)e[o].mark.bounds.clear();for(o=0;o<A;++o)(u=e[o]).x+=q[o]+=l,u.y+=I[o]+=f,w.union(u.mark.bounds.union(u.bounds.translate(q[o],I[o]))),g&&t.dirty(u);return w}function ft(t,e,n){var r,o,a,i,s,u,c,d=function(t){for(var e,n,r=t.items,o=r.length,a=0,i={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};a<o;++a)if(n=(e=r[a]).items,e.marktype===x)switch(e.role){case g:case k:break;case M:i.rowheaders.push(...n);break;case E:i.rowfooters.push(...n);break;case _:i.colheaders.push(...n);break;case A:i.colfooters.push(...n);break;case T:i.rowtitle=n[0];break;case z:i.coltitle=n[0];break;default:i.marks.push(...n)}return i}(e),l=d.marks,f=n.bounds===F?ht:mt,h=n.offset,y=n.columns||l.length,b=y<0?1:Math.ceil(l.length/y),p=b*y;const w=lt(t,l,n);d.rowheaders&&(u=ct(n.headerBand,H,null),r=xt(t,d.rowheaders,l,y,b,-ct(h,"rowHeader"),yt,0,f,"x1",0,y,1,u)),d.colheaders&&(u=ct(n.headerBand,G,null),o=xt(t,d.colheaders,l,y,y,-ct(h,"columnHeader"),yt,1,f,"y1",0,1,y,u)),d.rowfooters&&(u=ct(n.footerBand,H,null),a=xt(t,d.rowfooters,l,y,b,ct(h,"rowFooter"),bt,0,f,"x2",y-1,y,1,u)),d.colfooters&&(u=ct(n.footerBand,G,null),i=xt(t,d.colfooters,l,y,y,ct(h,"columnFooter"),bt,1,f,"y2",p-y,1,y,u)),d.rowtitle&&(s=ct(n.titleAnchor,H),c=ct(h,"rowTitle"),c=s===m?a+c:r-c,u=ct(n.titleBand,H,.5),gt(t,d.rowtitle,c,0,w,u)),d.coltitle&&(s=ct(n.titleAnchor,G),c=ct(h,"columnTitle"),c=s===m?i+c:o-c,u=ct(n.titleBand,G,.5),gt(t,d.coltitle,c,1,w,u))}function ht(t,e){return"x1"===e?t.x||0:"y1"===e?t.y||0:"x2"===e?(t.x||0)+(t.width||0):"y2"===e?(t.y||0)+(t.height||0):void 0}function mt(t,e){return t.bounds[e]}function yt(t,e){return Math.floor(Math.min(t,e))}function bt(t,e){return Math.ceil(Math.max(t,e))}function xt(t,e,n,r,o,a,i,s,u,c,d,l,f,h){var m,y,b,x,g,p,w,v,k,M=n.length,E=0,T=0;if(!M)return E;for(m=d;m<M;m+=l)n[m]&&(E=i(E,u(n[m],c)));if(!e.length)return E;for(e.length>o&&(t.warn("Grid headers exceed limit: "+o),e=e.slice(0,o)),E+=a,y=0,x=e.length;y<x;++y)t.dirty(e[y]),e[y].mark.bounds.clear();for(m=d,y=0,x=e.length;y<x;++y,m+=l){for(g=(p=e[y]).mark.bounds,b=m;b>=0&&null==(w=n[b]);b-=f);s?(v=null==h?w.x:Math.round(w.bounds.x1+h*w.bounds.width()),k=E):(v=E,k=null==h?w.y:Math.round(w.bounds.y1+h*w.bounds.height())),g.union(p.bounds.translate(v-(p.x||0),k-(p.y||0))),p.x=v,p.y=k,t.dirty(p),T=i(T,g[c])}return T}function gt(t,e,n,r,o,a){if(e){t.dirty(e);var i=n,s=n;r?i=Math.round(o.x1+a*o.width()):s=Math.round(o.y1+a*o.height()),e.bounds.translate(i-(e.x||0),s-(e.y||0)),e.mark.bounds.clear().union(e.bounds),e.x=i,e.y=s,t.dirty(e)}}function pt(t,e,n,r,y,b,x){const g=function(t,e){const n=t[e]||{};return(e,r)=>null!=n[e]?n[e]:null!=t[e]?t[e]:r}(n,e),p=function(t,e){var n=-1/0;return t.forEach(t=>{null!=t.offset&&(n=Math.max(n,t.offset))}),n>-1/0?n:e}(t,g("offset",0)),w=g("anchor",f),v=w===m?1:w===h?.5:0,k={align:C,bounds:g("bounds",F),columns:"vertical"===g("direction")?1:t.length,padding:g("margin",8),center:g("center"),nodirty:!0};switch(e){case a:k.anchor={x:Math.floor(r.x1)-p,column:m,y:v*(x||r.height()+2*r.y1),row:w};break;case i:k.anchor={x:Math.ceil(r.x2)+p,y:v*(x||r.height()+2*r.y1),row:w};break;case o:k.anchor={y:Math.floor(y.y1)-p,row:m,x:v*(b||y.width()+2*y.x1),column:w};break;case s:k.anchor={y:Math.ceil(y.y2)+p,x:v*(b||y.width()+2*y.x1),column:w};break;case u:k.anchor={x:p,y:p};break;case c:k.anchor={x:b-p,y:p,column:m};break;case d:k.anchor={x:p,y:x-p,row:m};break;case l:k.anchor={x:b-p,y:x-p,column:m,row:m}}return k}function wt(t,e){var r,o,u,c,d=e.items[0],l=d.datum,f=d.orient,h=d.bounds,y=d.x,b=d.y;return d._bounds?d._bounds.clear().union(h):d._bounds=h.clone(),h.clear(),function(t,e,n){var r=e.padding,o=r-n.x,u=r-n.y;if(e.datum.title){var c=e.items[1].items[0],d=c.anchor,l=e.titlePadding||0,f=r-c.x,h=r-c.y;switch(c.orient){case a:o+=Math.ceil(c.bounds.width())+l;break;case i:case s:break;default:u+=c.fontSize+l}switch((o||u)&&kt(t,n,o,u),c.orient){case a:h+=vt(e,n,c,d,0,1);break;case i:f+=vt(e,n,c,m,1,0)+l,h+=vt(e,n,c,d,0,1);break;case s:f+=vt(e,n,c,d,1,0),h+=vt(e,n,c,m,0,0,1)+l;break;default:f+=vt(e,n,c,d,1,0)}(f||h)&&kt(t,c,f,h),(f=Math.round(c.bounds.x1-r))<0&&(kt(t,n,-f,0),kt(t,c,-f,0))}else(o||u)&&kt(t,n,o,u)}(t,d,d.items[0].items[0]),h=function(t,e){return t.items.forEach(t=>e.union(t.bounds)),e.x1=t.padding,e.y1=t.padding,e}(d,h),r=2*d.padding,o=2*d.padding,h.empty()||(r=Math.ceil(h.width()+r),o=Math.ceil(h.height()+o)),l.type===D&&(u=d.items[0].items[0].items[0].items,c=u.reduce(function(t,e){return t[e.column]=Math.max(e.bounds.x2-e.x,t[e.column]||0),t},{}),u.forEach(function(t){t.width=c[t.column],t.height=t.bounds.y2-t.y})),f!==I&&(d.x=y=0,d.y=b=0),d.width=r,d.height=o,n.boundStroke(h.set(y,b,y+r,b+o),d),d.mark.bounds.clear().union(h),d}function vt(t,e,n,r,o,a,i){const s="symbol"!==t.datum.type,u=n.datum.vgrad,c=(!s||!a&&u||i?e:e.items[0]).bounds[o?"x2":"y2"]-t.padding,d=u&&a?c:0,l=u&&a?0:c;return Math.round(r===f?d:r===m?l:.5*c)}function kt(t,e,n,r){e.x+=n,e.y+=r,e.bounds.translate(n,r),e.mark.bounds.translate(n,r),t.dirty(e)}function Mt(t){e.Transform.call(this,null,t)}r.inherits(Mt,e.Transform).transform=function(t,e){var r=e.dataflow;return t.mark.items.forEach(function(e){t.layout&&ft(r,e,t.layout),function(t,e,r){var u,c,d,l,h,y=e.items,b=Math.max(0,e.width||0),D=Math.max(0,e.height||0),P=(new n.Bounds).set(0,0,b,D),C=P.clone(),F=P.clone(),G=[];for(l=0,h=y.length;l<h;++l)switch((c=y[l]).role){case g:(ot(c)?C:F).union(at(t,c,b,D));break;case p:u=c;break;case k:G.push(wt(t,c));break;case w:case v:case M:case E:case T:case _:case A:case z:C.union(c.bounds),F.union(c.bounds);break;default:P.union(c.bounds)}if(G.length){const e={};G.forEach(t=>{(d=t.orient||i)!==I&&(e[d]||(e[d]=[])).push(t)});for(let n in e){const o=e[n];lt(t,o,pt(o,n,r.legends,C,F,b,D))}G.forEach(e=>{const n=e.bounds;if(n.equals(e._bounds)||(e.bounds=e._bounds,t.dirty(e),e.bounds=n,t.dirty(e)),r.autosize&&r.autosize.type===O)switch(e.orient){case a:case i:P.add(n.x1,0).add(n.x2,0);break;case o:case s:P.add(0,n.y1).add(0,n.y2)}else P.union(n)})}P.union(C).union(F),u&&P.union(function(t,e,n,r,u){var c,d=e.items[0],l=d.frame,h=d.orient,y=d.anchor,b=d.offset,g=d.bounds,p=0,w=h===a||h===i?r:n,v=0,k=0;switch(l!==x?h===a?(p=u.y2,w=u.y1):h===i?(p=u.y1,w=u.y2):(p=u.x1,w=u.x2):h===a&&(p=r,w=0),c=y===f?p:y===m?w:(p+w)/2,et.clear().union(g),h){case o:v=c,k=u.y1-b;break;case a:v=u.x1-b,k=c;break;case i:v=u.x2+b,k=c;break;case s:v=c,k=u.y2+b;break;default:v=d.x,k=d.y}return g.translate(v-(d.x||0),k-(d.y||0)),nt(d,"x",v)|nt(d,"y",k)&&(d.bounds=et,t.dirty(d),d.bounds=g,t.dirty(d)),e.bounds.clear().union(g)}(t,u,b,D,P));e.clip&&P.set(0,0,e.width||0,e.height||0);!function(t,e,n,r){var o=r.autosize||{},a=o.type,i=t._width,s=t._height,u=t.padding();if(t._autosize<1||!a)return;var c=Math.max(0,e.width||0),d=Math.max(0,Math.ceil(-n.x1)),l=Math.max(0,Math.ceil(n.x2-c)),f=Math.max(0,e.height||0),h=Math.max(0,Math.ceil(-n.y1)),m=Math.max(0,Math.ceil(n.y2-f));o.contains===B&&(i-=u.left+u.right,s-=u.top+u.bottom);a===I?(d=0,h=0,c=i,f=s):a===O?(c=Math.max(0,i-d-l),f=Math.max(0,s-h-m)):a===S?(c=Math.max(0,i-d-l),s=f+h+m):a===j?(i=c+d+l,f=Math.max(0,s-h-m)):a===q&&(i=c+d+l,s=f+h+m);t._resizeView(i,s,c,f,[d,h],o.resize)}(t,e,P,r)}(r,e,t)}),t.modified()&&e.reflow(),e},t.bound=L,t.identifier=V,t.mark=W,t.overlap=J,t.render=tt,t.viewlayout=Mt,Object.defineProperty(t,"__esModule",{value:!0})});